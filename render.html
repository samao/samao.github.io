<html>
    <head>
        <title>弹幕DEMO测试</title>
        <meta charset="utf-8">
        <script type="text/javascript" src="./js/flv.min.js"></script>
        <script type="text/javascript" src="./js/danmu-render.js"></script>
        <style>
            body {
                -webkit-font-smoothing: antialiased;
            }
            * {
                padding: 0;
                margin: 0;
                box-sizing:border-box;
            }
            :focus {
                outline: none;
            }
            .root {
                position: relative;
                width: 900px;
                height: 600px;
                margin: 20px auto;
                background-color: #000;
            }

            .root video {
                width: 100%;
                height: 100%;
            }

            .danmu-item {
                position: absolute;
                white-space: nowrap;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                perspective:500px;
                padding: 1px 0;
            }

            .root ul {
                list-style: none;
                position: absolute;
                top: 100%;
                display: flex;
                margin-top: 10px;
                font-size: 12px;
            }

            .root ul li:not(:last-child) {
                margin-right: 10px;
            }

            .root ul li button {
                padding: 3px 10px;
                box-sizing: border-box;
                border: 1px solid #999;
                border-radius: 8px;
                cursor: pointer;
            }

            .root .blocked {
                display: flex;
                align-items: center;
            }

            .root .blocked label {
                margin: 0 10px;
            }

        </style>
    </head>
    <body>
        <div class='root'>
            <video muted autoplay loop preload="metadata"></video>
            <div class="danmu-container" onclick="toggle()" ></div>
            <ul>
                <li>
                    <button onclick="createCore('css')">css渲染</button>
                </li>
                <li>
                    <button onclick="createCore('canvas')">canvas渲染</button>
                </li>
                <li class='blocked'>
                    <label for="move">滚动</label>
                    <input type="checkbox" name="blocked" id='move' checked>
                    <label for="top">顶部</label>
                    <input type="checkbox" name="blocked" id="top" checked>
                    <label for="bottom">底部</label>
                    <input type="checkbox" name="blocked" id="bottom" checked>
                </li>
            </ul>
        </div>
        <script>
            var render, id = 0, task;

            var blocked = {
                move: false,
                top: false,
                bottom: false
            }
            var blockeds = document.querySelector('.blocked');

            function createCore(type) {
                if(render) {
                    render.destroy();
                    clearInterval(task);
                }
                render = new DanmuRender({
                    islive: true,
                    renderType: type,
                    video: document.querySelector('video'),
                    container: document.querySelector('.danmu-container'),
                    autoStart: true
                });
                render.blockedType = blocked;
                start();
            }

            function start() {
                return task = setInterval(function addDanmu() {
                    var mode = 'move';
                    var ran = Math.random();
                    if(ran < 0.3) mode = 'top';
                    if(ran < 0.2) mode = 'bottom';
                    render.add({
                        id: id++,
                        color: Math.random() * 0xffffff |0,
                        size: ((Math.random() * 20)|0) + 14,
                        mode,
                        time: 0,
                        message: '测试弹幕'+((Math.random()*100000000)|0)
                    })
                }, 100);
            }

            function toggle() {
                var video = document.querySelector('video');
                if(video.paused) {
                    video.play();
                    render.resume();
                    start();
                } else {
                    video.pause();
                    render.pause();
                    clearInterval(task);
                }
            }

            blockeds.addEventListener('click', (e) => {
                if(e.target instanceof HTMLInputElement) {
                    Object.assign(blocked, {[e.target.id]: !e.target.checked});
                    if(render) {
                        render.blockedType = blocked;
                    }
                }
            })

            //播放视频
-            if (flvjs.isSupported()) {
-                var videoElement = document.querySelector('video');
-                var flvPlayer = flvjs.createPlayer({
-                    islive: true,
-                    type: 'flv',
-                    url: './streams/live.flv'
-                });
-                flvPlayer.attachMediaElement(videoElement);
-                flvPlayer.load();
-                flvPlayer.play();
-            }

            createCore('canvas');
        </script>
    </body>
</html>