(this.webpackJsonp_name_=this.webpackJsonp_name_||[]).push([[16],{189:function(e,t,i){"use strict";var r,n=i(49),o=i(22),s=i(2),a=i(14),d=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),u=function(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,o=i.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s},f=function(e,t,i){if(i||2===arguments.length)for(var r,n=0,o=t.length;n<o;n++)!r&&n in t||(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return e.concat(r||Array.prototype.slice.call(t))},h=s.a.warn.bind(null,"[@Demux]"),l=function(e){function t(t){var i=e.call(this)||this;return i.config=t,i._bandwidths=[],i._inited=!1,i._switching=!1,i._level=0,i._demuxType=a.a.LAS,i.internalReport=function(){i.emit(o.b.BAND_WIDTH,i.bandwidth)},i._media=t.video,i._startLevel=t.startLevel,i._demuxType=t.demuxType,i._observer=t.observer,i}return d(t,e),t.prototype.emit=function(e){for(var t,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];return e===o.b.DESTROYED?this.disabledReport():e===o.b.METADATA&&this.enabledReport(),e===o.a.ERROR&&h(JSON.stringify(i)),(t=this._observer).emit.apply(t,f([e],u(i),!1))},Object.defineProperty(t.prototype,"codecs",{get:function(){return this._codecs},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"levels",{get:function(){return this._levels},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"level",{get:function(){return this._level},set:function(e){this._level=e,this.onSwitching()},enumerable:!1,configurable:!0}),t.prototype.onSwitching=function(){this._inited&&(this._switching=!0,this._media.dispatchEvent(new Event("waiting")),this.emit(o.b.SWITCHING))},t.prototype.onSwitched=function(){this._inited&&this._switching&&(this._switching=!1,this._media.dispatchEvent(new Event("canplay")),this.emit(o.b.SWITCHED))},t.prototype.initBitrate=function(){this.emit(o.b.BITRATE_UPDATE,this._levels)},t.prototype.enabledReport=function(){clearInterval(this._reportTask),this._reportTask=setInterval(this.internalReport,200)},t.prototype.disabledReport=function(){clearInterval(this._reportTask),this._bandwidths.length=0},t.prototype.appendBandwidth=function(e){this._bandwidths.length>20&&this._bandwidths.shift(),this._bandwidths.push(e)},Object.defineProperty(t.prototype,"bandwidth",{get:function(){return 0===this._bandwidths.length?0:this._bandwidths.reduce((function(e,t){return e+t}),0)/this._bandwidths.length},enumerable:!1,configurable:!0}),t}(n.EventEmitter);t.a=l},231:function(e,t,i){var r;"undefined"!=typeof window&&(r=function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s="./src/index.ts")}({"../../node_modules/.pnpm/events@3.3.0/node_modules/events/events.js":function(e,t,i){"use strict";var r,n="object"==typeof Reflect?Reflect:null,o=n&&"function"==typeof n.apply?n.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};r=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,e.exports.once=function(e,t){return new Promise((function(i,r){function n(i){e.removeListener(t,o),r(i)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",n),i([].slice.call(arguments))}m(e,t,o,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&m(e,"error",t,i)}(e,n,{once:!0})}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var d=10;function u(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function f(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function h(e,t,i,r){var n,o,s,a;if(u(i),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),s=o[t]),void 0===s)s=o[t]=i,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[i,s]:[s,i]:r?s.unshift(i):s.push(i),(n=f(e))>0&&s.length>n&&!s.warned){s.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=s.length,a=d,console&&console.warn&&console.warn(a)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},n=l.bind(r);return n.listener=i,r.wrapFn=n,n}function c(e,t,i){var r=e._events;if(void 0===r)return[];var n=r[t];return void 0===n?[]:"function"==typeof n?i?[n.listener||n]:[n]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(n):v(n,n.length)}function p(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function v(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}function m(e,t,i,r){if("function"==typeof e.on)r.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function n(o){r.once&&e.removeEventListener(t,n),i(o)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");d=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return f(this)},a.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,n=this._events;if(void 0!==n)r=r&&void 0===n.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var d=n[e];if(void 0===d)return!1;if("function"==typeof d)o(d,this,t);else{var u=d.length,f=v(d,u);for(i=0;i<u;++i)o(f[i],this,t)}return!0},a.prototype.addListener=function(e,t){return h(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return h(this,e,t,!0)},a.prototype.once=function(e,t){return u(t),this.on(e,_(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return u(t),this.prependListener(e,_(this,e,t)),this},a.prototype.removeListener=function(e,t){var i,r,n,o,s;if(u(t),void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(n=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){s=i[o].listener,n=o;break}if(n<0)return this;0===n?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,n),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var n,o=Object.keys(i);for(r=0;r<o.length;++r)"removeListener"!==(n=o[r])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},a.prototype.listeners=function(e){return c(this,e,!0)},a.prototype.rawListeners=function(e){return c(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},a.prototype.listenerCount=p,a.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},"../../node_modules/.pnpm/webworkify-webpack@2.1.5/node_modules/webworkify-webpack/index.js":function(e,t,i){function r(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw console.error(e),e};var r=i(i.s=ENTRY_MODULE);return r.default||r}function n(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(e,t,r){var o={};o[r]=[];var s=t.toString(),a=s.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!a)return o;for(var d,u=a[1],f=new RegExp("(\\\\n|\\W)"+n(u)+"\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)","g");d=f.exec(s);)"dll-reference"!==d[3]&&o[r].push(d[3]);for(f=new RegExp("\\("+n(u)+'\\("(dll-reference\\s([\\.|\\-|\\+|\\w|/|@]+))"\\)\\)\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)',"g");d=f.exec(s);)e[d[2]]||(o[r].push(d[1]),e[d[2]]=i(d[1]).m),o[d[2]]=o[d[2]]||[],o[d[2]].push(d[4]);for(var h,l=Object.keys(o),_=0;_<l.length;_++)for(var c=0;c<o[l[_]].length;c++)h=o[l[_]][c],isNaN(1*h)||(o[l[_]][c]=1*o[l[_]][c]);return o}function s(e){return Object.keys(e).reduce((function(t,i){return t||e[i].length>0}),!1)}e.exports=function(e,t){t=t||{};var n={main:i.m},a=t.all?{main:Object.keys(n.main)}:function(e,t){for(var i={main:[t]},r={main:[]},n={main:{}};s(i);)for(var a=Object.keys(i),d=0;d<a.length;d++){var u=a[d],f=i[u].pop();if(n[u]=n[u]||{},!n[u][f]&&e[u][f]){n[u][f]=!0,r[u]=r[u]||[],r[u].push(f);for(var h=o(e,e[u][f],u),l=Object.keys(h),_=0;_<l.length;_++)i[l[_]]=i[l[_]]||[],i[l[_]]=i[l[_]].concat(h[l[_]])}}return r}(n,e),d="";Object.keys(a).filter((function(e){return"main"!==e})).forEach((function(e){for(var t=0;a[e][t];)t++;a[e].push(t),n[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",d=d+"var "+e+" = ("+r.toString().replace("ENTRY_MODULE",JSON.stringify(t))+")({"+a[e].map((function(t){return JSON.stringify(t)+": "+n[e][t].toString()})).join(",")+"});\n"})),d=d+"new (("+r.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+a.main.map((function(e){return JSON.stringify(e)+": "+n.main[e].toString()})).join(",")+"}))(self);";var u=new window.Blob([d],{type:"text/javascript"});if(t.bare)return u;var f=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(u),h=new window.Worker(f);return h.objectURL=f,h}},"./src/core/errors.ts":function(e,t,i){"use strict";var r,n;i.r(t),i.d(t,"ErrorTypes",(function(){return r})),i.d(t,"ErrorDetails",(function(){return n})),function(e){e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e.MSE_ERROR="mseError"}(r||(r={})),function(e){e[e.LOAD_ERROR=10]="LOAD_ERROR",e[e.LOAD_ERROR_TIMEOUT=11]="LOAD_ERROR_TIMEOUT",e[e.VIDEO_ERROR=101]="VIDEO_ERROR",e[e.UNSUPPORTED=102]="UNSUPPORTED",e[e.CONFIG_ERROR=103]="CONFIG_ERROR",e[e.MANIFEST_ERROR=104]="MANIFEST_ERROR",e[e.NO_VIDEO=105]="NO_VIDEO",e[e.MEDIASOURCE_ERROR=200]="MEDIASOURCE_ERROR",e[e.ADDSOURCEBUFFER_ERROR=201]="ADDSOURCEBUFFER_ERROR",e[e.SOURCEBUFFER_ERROR=202]="SOURCEBUFFER_ERROR",e[e.ENDOFSTREAM_ERROR=203]="ENDOFSTREAM_ERROR",e[e.APPENDBUFFER_ERROR=204]="APPENDBUFFER_ERROR",e[e.DEMUX_ERROR=301]="DEMUX_ERROR",e[e.REMUX_ERROR=302]="REMUX_ERROR",e[e.REMUX_ALLOC_ERROR=303]="REMUX_ALLOC_ERROR"}(n||(n={}))},"./src/core/events.ts":function(e,t,i){"use strict";i.r(t),t.default={MEDIA_INFO:"mediaInfo",MP4_SEGMENT:"mp4Segment",SCRIPT_PARSED:"scriptParsed",LOAD_END:"loadEnd",ERROR:"lasError",LEVEL_SWITCH_FAILED:"levelSwitchFailed",LEVEL_SWITCHING:"levelSwitching",LEVEL_SWITCHED:"levelSwitched",MANIFEST_PARSED:"manifestParsed",FLV_HEAD:"flvHead",REPORT:"report",HEARTBEAT:"heartbeat"}},"./src/core/worker-cmd.ts":function(e,t,i){"use strict";var r;i.r(t),i.d(t,"WorkerCmd",(function(){return r})),function(e){e.INIT="init",e.FLV_HEAD="flvHead",e.SET_CODECS="setCodecs",e.FLUSH="flush",e.APPEND_DATA="appendData",e.LOAD_END="loadEnd",e.DESTROY="destroy",e.SET_EXTRA="setExtra"}(r||(r={}))},"./src/demux/flv/flv-demuxer-inline.ts":function(e,t,i){"use strict";i.r(t);var r,n=i("./src/core/events.ts"),o=i("./src/core/errors.ts");!function(e){e.video="video",e.audio="audio"}(r||(r={}));var s={"mp4a.40.2":{1:new Uint8Array([0,200,0,128,35,128]),2:new Uint8Array([33,0,73,144,2,25,0,35,128]),3:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]),4:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]),5:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]),6:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])},"mp4a.40.5":{1:new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]),2:new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]),3:new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}};function a(e){return 1024e3/e}function d(e,t){return s[e]||(e="mp4a.40.5"),s[e][t]}var u=i("./src/utils/log.ts"),f=Math.pow(2,32)-1,h={video:new Uint8Array([0,0,0,45,104,100,108,114,0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,45,104,100,108,114,0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])},l=new Uint8Array([0,0,0,24,102,116,121,112,105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]),_=new Uint8Array([0,0,0,16,115,116,116,115,0,0,0,0,0,0,0,0]),c=new Uint8Array([0,0,0,16,115,116,115,99,0,0,0,0,0,0,0,0]),p=new Uint8Array([0,0,0,16,115,116,99,111,0,0,0,0,0,0,0,0]),v=new Uint8Array([0,0,0,20,115,116,115,122,0,0,0,0,0,0,0,0,0,0,0,0]),m=new Uint8Array([0,0,0,36,100,105,110,102,0,0,0,28,100,114,101,102,0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),g=new Uint8Array([0,0,0,20,118,109,104,100,0,0,0,1,0,0,0,0,0,0,0,0]),y=new Uint8Array([0,0,0,16,115,109,104,100,0,0,0,0,0,0,0,0]),E=new Uint8Array([0,0,0,20,98,116,114,116,0,28,156,128,0,45,198,192,0,45,198,192]),b=new Uint8Array([0,0,0,120,109,118,104,100,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]),S=new Uint8Array([0,0,0,104,116,107,104,100,1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0]),L=new Uint8Array([0,0,0,32,116,114,101,120,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]),T=new Uint8Array([0,0,0,44,109,100,104,100,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,0,0,172,68,0,0,0,0,0,0,0,0,85,196,0,0]),R=new Uint8Array([0,0,0,93,115,116,115,100,0,0,0,0,0,0,0,1,0,0,0,77,109,112,52,97,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,16,0,0,0,0,172,68,0,0,0,0,0,41,101,115,100,115,0,0,0,0,3,27,0,1,0,4,19,64,21,0,0,0,0,0,0,0,0,0,0,0,5]),w=new Uint8Array([0,0,0,185,115,116,115,100,0,0,0,0,0,0,0,1,0,0,0,169,97,118,99,49,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,2,208,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),O=new Uint8Array([0,0,0,16,112,97,115,112,0,0,0,1,0,0,0,1]),M=function(){function e(){}return e.moov=function(t){var i=l.byteLength+e._getMoovLen(t),r={data:new Uint8Array(i),offset:0};return r.data.set(l,0),r.offset+=l.byteLength,e._writeMoov(r,t),r.data},e.videoMediaSegment=function(t,i,r,n){var o=8+r.mp4Samples.reduce((function(e,t){return e+t.units.reduce((function(e,t){return e+t.byteLength+4}),0)}),0),s=e._getMediaSegmentData(r,o,n);return e._mediaSegmentHead(s,t,i,r,o,n),r.samples.forEach((function(e){e.units.forEach((function(e){var t=e.byteLength;s.data[s.offset]=t>>24&255,s.data[s.offset+1]=t>>16&255,s.data[s.offset+2]=t>>8&255,s.data[s.offset+3]=255&t,s.data.set(e,s.offset+4),s.offset+=4+t})),delete e.units})),s.data},e.audioMediaSegment=function(t,i,r,n){var o=8+r.mp4Samples.reduce((function(e,t){return e+t.unit.byteLength}),0),s=e._getMediaSegmentData(r,o,n);return e._mediaSegmentHead(s,t,i,r,o,n),r.mp4Samples.forEach((function(e){s.data.set(e.unit,s.offset),s.offset+=e.unit.byteLength,delete e.unit})),s.data},e._getMoovLen=function(t){var i=t.reduce((function(t,i){return t+e._getTrakLen(i)}),0);return 8+b.byteLength+i+e._getMvexLen(t)},e._writeMoov=function(t,i){var r=e._getMoovLen(i);e._writeBoxHead(t,e.types.moov,r),e._writeMvhd(t,i[0].timescale,i[0].duration),i.forEach((function(i){e._writeTrak(t,i)})),e._writeMvex(t,i)},e._getMoofLen=function(e){return 100+17*e},e._mediaSegmentHead=function(t,i,r,n,o,s){s&&(t.data.set(s),t.offset=s.byteLength),e._writeMoof(t,i,r,n),e._writeBoxHead(t,e.types.mdat,o)},e._getMediaSegmentData=function(t,i,r){var n=e._getMoofLen(t.mp4Samples.length);return{data:new Uint8Array(n+i+(r?r.byteLength:0)),offset:0}},e._writeMvhd=function(e,t,i){i*=t;var r=Math.floor(i/(f+1)),n=Math.floor(i%(f+1)),o=b;o[28]=t>>24&255,o[29]=t>>16&255,o[30]=t>>8&255,o[31]=255&t,o[32]=r>>24,o[33]=r>>16&255,o[34]=r>>8&255,o[35]=255&r,o[36]=n>>24,o[37]=n>>16&255,o[38]=n>>8&255,o[39]=255&n,e.data.set(o,e.offset),e.offset+=b.byteLength},e._writeTkhd=function(e,t){var i=t.id,r=t.duration*t.timescale,n=Math.floor(r/(f+1)),o=Math.floor(r%(f+1)),s=0,a=0;t.hasOwnProperty("width")&&(s=t.width),t.hasOwnProperty("height")&&(a=t.height);var d=S;d[28]=i>>24&255,d[29]=i>>16&255,d[30]=i>>8&255,d[31]=255&i,d[36]=n>>24,d[37]=n>>16&255,d[38]=n>>8&255,d[39]=255&n,d[40]=o>>24,d[41]=o>>16&255,d[42]=o>>8&255,d[43]=255&o,d[96]=s>>8&255,d[97]=255&s,d[100]=a>>8&255,d[101]=255&a,e.data.set(d,e.offset),e.offset+=S.byteLength},e._getTrakLen=function(t){return 8+S.byteLength+e._getMdiaLen(t)},e._writeTrak=function(t,i){var r=e._getTrakLen(i);this._writeBoxHead(t,e.types.trak,r),this._writeTkhd(t,i),this._writeMdia(t,i)},e._getMdiaLen=function(t){return 8+T.byteLength+h[t.type].byteLength+e._getMinfLen(t)},e._writeMdia=function(t,i){var r=e._getMdiaLen(i);this._writeBoxHead(t,e.types.mdia,r),this._writeMdhd(t,i.timescale,i.duration),t.data.set(h[i.type],t.offset),t.offset+=h[i.type].byteLength,this._writeMinf(t,i)},e._writeMdhd=function(e,t,i){i*=t;var r=Math.floor(i/(f+1)),n=Math.floor(i%(f+1)),o=T;o[28]=t>>24&255,o[29]=t>>16&255,o[30]=t>>8&255,o[31]=255&t,o[32]=r>>24,o[33]=r>>16&255,o[34]=r>>8&255,o[35]=255&r,o[36]=n>>24,o[37]=n>>16&255,o[38]=n>>8&255,o[39]=255&n,e.data.set(o,e.offset),e.offset+=o.byteLength},e._getMinfLen=function(t){return t.type===r.audio?8+y.byteLength+m.byteLength+e._getStblLen(t):8+g.byteLength+m.byteLength+e._getStblLen(t)},e._writeMinf=function(t,i){if(this._writeBoxHead(t,e.types.minf,e._getMinfLen(i)),"audio"===i.type)return t.data.set(y,t.offset),t.offset+=y.byteLength,t.data.set(m,t.offset),t.offset+=m.byteLength,void this._writeStbl(t,i);t.data.set(g,t.offset),t.offset+=g.byteLength,t.data.set(m,t.offset),t.offset+=m.byteLength,this._writeStbl(t,i)},e._getStblLen=function(e){return 8+this._getStsdLen(e)+_.byteLength+c.byteLength+v.byteLength+p.byteLength},e._writeStbl=function(t,i){var r=this._getStblLen(i);this._writeBoxHead(t,e.types.stbl,r),this._writeStsd(t,i),t.data.set(_,t.offset),t.offset+=_.byteLength,t.data.set(c,t.offset),t.offset+=c.byteLength,t.data.set(v,t.offset),t.offset+=v.byteLength,t.data.set(p,t.offset),t.offset+=p.byteLength},e._getStsdLen=function(t){return t.type===r.audio?e._getMp4aStsdLen(t):e._getAvc1StsdLen(t)},e._writeStsd=function(e,t){t.type!==r.audio?this._writeAvc1Stsd(e,t):this._writeMp4aStsd(e,t)},e._getAvcCLen=function(e){return 15+e.sps.reduce((function(e,t){return e+t.byteLength+2}),0)+e.pps.reduce((function(e,t){return e+t.byteLength+2}),0)},e._getAvc1Len=function(t){return 86+e._getAvcCLen(t)+20+16},e._getAvc1StsdLen=function(e){return 16+this._getAvc1Len(e)},e._writeAvc1Stsd=function(t,i){var r,n,o,s=[],a=[];for(r=0;r<i.sps.length;r++)o=(n=i.sps[r]).byteLength,s.push(o>>>8&255),s.push(255&o),s=s.concat(Array.prototype.slice.call(n));for(r=0;r<i.pps.length;r++)o=(n=i.pps[r]).byteLength,a.push(o>>>8&255),a.push(255&o),a=a.concat(Array.prototype.slice.call(n));var d=this._getAvcCLen(i),u=this._getAvc1Len(i),f=this._getAvc1StsdLen(i),h=w,l=i.width,_=i.height,c=i.pixelRatio[0],p=i.pixelRatio[1];h[0]=f>>24&255,h[1]=f>>16&255,h[2]=f>>8&255,h[3]=255&f,h[16]=u>>24&255,h[17]=u>>16&255,h[18]=u>>8&255,h[19]=255&u,h[48]=l>>8&255,h[49]=255&l,h[50]=_>>8&255,h[51]=255&_,t.data.set(h,t.offset),t.offset+=h.byteLength,this._writeBoxHead(t,e.types.avcC,d);var v=[1,s[3],s[4],s[5],255,224|i.sps.length].concat(s).concat([i.pps.length]).concat(a);t.data.set(v,t.offset),t.offset+=v.length,t.data.set(E,t.offset),t.offset+=E.byteLength;var m=O;m[8]=c>>24,m[9]=c>>16&255,m[10]=c>>8&255,m[11]=255&c,m[12]=p>>24,m[13]=p>>16&255,m[14]=p>>8&255,m[15]=255&p,t.data.set(m,t.offset),t.offset+=m.byteLength},e._getMp4aEsdsLen=function(e){return 33+e.config.length+4},e._getMp4aStsdLen=function(t){return 52+e._getMp4aEsdsLen(t)},e._writeMp4aStsd=function(t,i){var r=i.config.length,n=e._getMp4aEsdsLen(i),o=e._getMp4aStsdLen(i),s=o-16,a=R;a[0]=o>>24&255,a[1]=o>>16&255,a[2]=o>>8&255,a[3]=255&o,a[16]=s>>24&255,a[17]=s>>16&255,a[18]=s>>8&255,a[19]=255&s,a[41]=i.channelCount,a[48]=i.samplerate>>8&255,a[49]=255&i.samplerate,a[52]=n>>24&255,a[53]=n>>16&255,a[54]=n>>8&255,a[55]=255&n,a[65]=23+r,a[70]=15+r,t.data.set(a,t.offset),t.offset+=a.byteLength;var d=[r].concat(i.config).concat([6,1,2]);t.data.set(d,t.offset),t.offset+=d.length},e._getMvexLen=function(e){return 8+e.length*L.byteLength},e._writeMvex=function(t,i){var r=e._getMvexLen(i);this._writeBoxHead(t,e.types.mvex,r),i.forEach((function(i){e._writeTrex(t,i)}))},e._writeTrex=function(e,t){var i=t.id,r=L;r[12]=i>>24,r[13]=i>>16&255,r[14]=i>>8&255,r[15]=255&i,e.data.set(r,e.offset),e.offset+=r.byteLength},e._writeMoof=function(t,i,r,n){var o=n.mp4Samples.length,s=e._getMoofLen(o),a=s-24,d=12+o,u=20+16*o,h=s+8,l=n.id,_=n.mp4Samples||[],c=Math.floor(r/(f+1)),p=Math.floor(r%(f+1));e._writeBoxHead(t,e.types.moof,s),e._writeBoxHead(t,e.types.mfhd,16),t.data[t.offset+4]=i>>24,t.data[t.offset+5]=i>>16&255,t.data[t.offset+6]=i>>8&255,t.data[t.offset+7]=255&i,t.offset+=8,e._writeBoxHead(t,e.types.traf,a),e._writeBoxHead(t,e.types.tfhd,16),t.data[t.offset+4]=l>>24,t.data[t.offset+5]=l>>16&255,t.data[t.offset+6]=l>>8&255,t.data[t.offset+7]=255&l,t.offset+=8,e._writeBoxHead(t,e.types.tfdt,20),t.data[t.offset]=1,t.data[t.offset+4]=c>>24,t.data[t.offset+5]=c>>16&255,t.data[t.offset+6]=c>>8&255,t.data[t.offset+7]=255&c,t.data[t.offset+8]=p>>24,t.data[t.offset+9]=p>>16&255,t.data[t.offset+10]=p>>8&255,t.data[t.offset+11]=255&p,t.offset+=12,e._writeBoxHead(t,e.types.sdtp,d),t.offset+=4,_.forEach((function(e,i){var r=e.flags;t.data[t.offset+i]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy})),t.offset+=o,e._writeBoxHead(t,e.types.trun,u),t.data[t.offset+2]=15,t.data[t.offset+3]=1,t.data[t.offset+4]=o>>>24&255,t.data[t.offset+5]=o>>>16&255,t.data[t.offset+6]=o>>>8&255,t.data[t.offset+7]=255&o,t.data[t.offset+8]=h>>>24&255,t.data[t.offset+9]=h>>>16&255,t.data[t.offset+10]=h>>>8&255,t.data[t.offset+11]=255&h,t.offset+=12,_.forEach((function(e,i){t.data.set([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.len>>>24&255,e.len>>>16&255,e.len>>>8&255,255&e.len,e.flags.isLeading<<2|e.flags.dependsOn,e.flags.isDependedOn<<6|e.flags.hasRedundancy<<4|e.flags.isNonSync,61440&e.flags.degradPrio,15&e.flags.degradPrio,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts],t.offset+16*i)})),t.offset+=16*o},e._writeBoxHead=function(e,t,i){e.data[e.offset]=i>>24&255,e.data[e.offset+1]=i>>16&255,e.data[e.offset+2]=i>>8&255,e.data[e.offset+3]=255&i,e.data.set(t,e.offset+4),e.offset+=8},e}();M.types={avc1:[97,118,99,49],avcC:[97,118,99,67],btrt:[98,116,114,116],dinf:[100,105,110,102],dref:[100,114,101,102],esds:[101,115,100,115],ftyp:[102,116,121,112],hdlr:[104,100,108,114],mdat:[109,100,97,116],mdhd:[109,100,104,100],mdia:[109,100,105,97],mfhd:[109,102,104,100],minf:[109,105,110,102],moof:[109,111,111,102],moov:[109,111,111,118],mp4a:[109,112,52,97],mvex:[109,118,101,120],mvhd:[109,118,104,100],pasp:[112,97,115,112],sdtp:[115,100,116,112],stbl:[115,116,98,108],stco:[115,116,99,111],stsc:[115,116,115,99],stsd:[115,116,115,100],stsz:[115,116,115,122],stts:[115,116,116,115],tfdt:[116,102,100,116],tfhd:[116,102,104,100],traf:[116,114,97,102],trak:[116,114,97,107],trun:[116,114,117,110],trex:[116,114,101,120],tkhd:[116,107,104,100],vmhd:[118,109,104,100],smhd:[115,109,104,100]};var x=M;function k(){return(k=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(this,arguments)}var A=function(){function e(e,t){this.tag="MP4Remuxer",this._eventEmitter=void 0,this._forceFirstIDR=void 0,this._videoTimeReference=void 0,this._videoTimeReferenceInfo=void 0,this._extra=void 0,this._nextAudioPTS=void 0,this._nextVideoDTS=void 0,this._initPTS=void 0,this._videoLastPTS=0,this._audioLastPTS=0,this._videoSampleDuration=40,this._moovs=void 0,this._eventEmitter=e,this._videoTimeReference=!t.gopRemux,this._videoTimeReferenceInfo={},this._forceFirstIDR=navigator.userAgent.toLowerCase().indexOf("chrome")>-1}var t=e.prototype;return t.resetMoov=function(){this._moovs=void 0,this._clearVideoTimeReference()},t.setExtra=function(e){this._extra=e},t.resetTimeStamp=function(){this._initPTS=void 0,this._audioLastPTS=this._videoLastPTS=0},t.getLastPTS=function(){return{video:this._videoLastPTS,audio:this._audioLastPTS}},t.flush=function(){var e,t=this._videoTimeReferenceInfo;return this._videoTimeReference&&t.sample&&(t.track.samples=[t.sample],t.track.sequenceNumber++,t.sample=void 0,e=this._remuxVideo(t.track,!0,!1)),this._clearVideoTimeReference(),e},t.remux=function(e,t,i,r,o){if(void 0===o&&(o=!1),this._moovs||this._initMP4(e,t,i),this._moovs){var s,a;if(e.samples.length&&t.samples.length&&!r&&e.samples[0].pts<t.samples[0].pts){var d=k({},t.samples[0]);d.dts=d.pts=e.samples[0].pts,t.samples.unshift(d)}!r&&t.samples.length&&(t.samples[0].pts=t.samples[0].dts),s=this._remuxAudio(e,r),!(a=this._remuxVideo(t,r,!o))&&o&&this._videoTimeReferenceInfo.sample&&(a=this.flush()),a&&!s&&e.codec&&(s=this._fillEmptyAudio(e,r,a.startPTS,a.endPTS,a.streamDTS));var u=[];s&&u.push(s),a&&u.push(a),u.length&&this._eventEmitter.emit(n.default.MP4_SEGMENT,{segments:u,extra:this._extra})}},t._initMP4=function(e,t,i){var r,s=this._eventEmitter,a=e.samples,d=t.samples,u={},f={};if(e.config&&a.length&&(e.timescale=e.samplerate,f.audio=x.moov([e]),u.audioCodec=e.codec,u.channelCount=e.channelCount,u.audioSampleRate=e.samplerate,u.hasAudio=!0,u.defaultAudioCodec=e.defaultCodec,r=a[0].pts-e.inputTimescale*i),t.sps&&t.pps&&d.length){var h=t.inputTimescale;t.timescale=h,f.video=x.moov([t]),u.videoCodec=t.codec,u.width=t.width,u.height=t.height,u.fps=t.fps,u.profile=t.profile,u.level=t.level,u.chromaFormat=t.chromaFormat,u.hasVideo=!0;var l=d[0].pts-h*i,_=d[0].dts-h*i;r=r?Math.min(r,_):l}u.hasAudio||u.hasVideo?(void 0===this._initPTS&&(this._initPTS=r),this._moovs=f,s.emit(n.default.MEDIA_INFO,u)):s.emit(n.default.ERROR,{type:o.ErrorTypes.MUX_ERROR,details:o.ErrorDetails.DEMUX_ERROR,fatal:!1,info:{reason:"no audio/video samples found"}})},t._remuxVideo=function(e,t,i){if(void 0===i&&(i=!0),e.samples.length){var n=this._initPTS,o=e.timescale,s=e.samples,a=[],d=this._nextVideoDTS,u=0,f=s.length;if(void 0!==n&&0!==f&&0!==o){t&&void 0!==d||(d=s[0].dts),s.forEach((function(e){e.pts=e.pts-n,e.dts=e.dts-n})),s.sort((function(e,t){return e.dts-t.dts||e.pts-t.pts})),this._videoTimeReference&&(this._videoTimeReferenceInfo.track=e,this._videoTimeReferenceInfo.sample&&(f++,s.unshift(this._videoTimeReferenceInfo.sample),this._videoTimeReferenceInfo.sample=void 0),s.length>1&&i&&(this._videoTimeReferenceInfo.sample=s.pop(),f--));var h=s[0],l=Math.max(h.dts,0),_=Math.max(h.pts,0);t&&Math.round(l-d)&&(_=s[0].pts=_-(l-d),l=s[0].dts=l=d);for(var c=0;c<f;c++){var p,v=s[c];if(c<f-1){var m=s[c+1];if(m.dts<=v.dts){var g=m.pts-m.dts;m.dts=v.dts+1,m.pts=m.dts+g}u=m.dts-v.dts}else{var y=e.sampleDuration||this._videoSampleDuration;this._videoTimeReferenceInfo.sample&&(y=this._videoTimeReferenceInfo.sample.dts-v.dts),u=Math.floor(y)}var E=Math.round(v.pts-v.dts);p=v.units.reduce((function(e,t){return t.byteLength+4+e}),0),a.push({len:p,units:v.units,duration:u,cts:E,streamDTS:v.streamDTS,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:v.key?2:1,isNonSync:v.key?0:1}})}var b=s[s.length-1];this._nextVideoDTS=b.dts+u;var S=b.pts+u;if(a.length&&this._forceFirstIDR){var L=a[0].flags;L.dependsOn=2,L.isNonSync=0}e.mp4Samples=a;var T={payload:x.videoMediaSegment(e.sequenceNumber++,l,e,this._getMoovByType(r.video)),startPTS:_/o,endPTS:S/o,startDTS:l/o,endDTS:this._nextVideoDTS/o,type:r.video,streamDTS:h.streamDTS/o};return this._videoLastPTS=T.endPTS,this._videoSampleDuration=Math.max(u,1),e.samples=[],e.mp4Samples=[],T}}},t._remuxAudio=function(e,t){if(e.samples.length){var i,n=this._initPTS,o=e.inputTimescale,s=o/e.timescale,f=1024*s,h=[],l=e.samples,_=a(e.samplerate),c=this._nextAudioPTS,p=0;if(void 0!==n&&(l.forEach((function(e){e.pts=e.dts=e.pts-n})),t&&void 0!==c||(c=l[0].pts),void 0!==c)){for(var v=0,m=c;v<l.length;v++){var g=l[v],y=g.unit,E=g.pts,b=Math.round(E-m),S=Math.abs(1e3*b/o);if(b<=-f)u.Log.v(this.tag,"drop audio frame. pts: "+E);else{if(b>=f&&S<1e5&&m){var L=Math.round(b/f);u.Log.v(this.tag,"fill audio frame. count: "+L+" pts: "+E);for(var T=0;T<L;T++){var R=d(e.defaultCodec||e.codec,e.channelCount);R||(u.Log.v(this.tag,"fill copy audio frame"),R=y.subarray()),h.push({len:R.byteLength,unit:R,cts:0,duration:1024,streamDTS:Math.round(g.streamDTS-L*_),flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0}}),p=p||Math.max(m,0),m+=f}}else p=p||E,m+=f;h.push({len:y.byteLength,cts:0,duration:1024,unit:y,streamDTS:g.streamDTS,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0}}),i=E}}if(h.length&&"number"==typeof i){this._nextAudioPTS=c=i+1024*s,e.mp4Samples=h;var w=x.audioMediaSegment(e.sequenceNumber++,p/s,e,this._getMoovByType(r.audio));e.samples=[],e.mp4Samples=[];var O=p/o,M=c/o,k={payload:w,startPTS:O,endPTS:M,startDTS:O,endDTS:M,type:r.audio,streamDTS:h[0].streamDTS/o};return this._audioLastPTS=k.endPTS,k}e.samples=[],e.mp4Samples=[]}}},t._fillEmptyAudio=function(e,t,i,r,n){u.Log.v(this.tag,"fill empty Audio");var o=d(e.defaultCodec||e.codec,e.channelCount);if(void 0!==this._initPTS&&o){for(var s=e.inputTimescale,f=(void 0!==this._nextAudioPTS?this._nextAudioPTS:i*s)+this._initPTS,h=r*s+this._initPTS,l=a(e.samplerate),_=Math.ceil((h-f)/l),c=[],p=0;p<_;p++){var v=f+p*l;c.push({unit:o,pts:v,dts:v,streamDTS:Math.round(n*s+p*l)})}return e.samples=c,this._remuxAudio(e,t)}},t._getMoovByType=function(e){var t;return this._moovs&&this._moovs[e]&&(t=this._moovs[e],delete this._moovs[e]),t},t._clearVideoTimeReference=function(){this._videoTimeReferenceInfo={}},e}(),D=i("./src/types/flv-object.ts"),C=i("./src/utils/browser-helper.ts"),P=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];function I(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}var F=function(){function e(e){this._data=void 0,this._byteIndex=void 0,this._bitIndex=void 0,this._data=e,this._byteIndex=0,this._bitIndex=0}var t,i,r,n=e.prototype;return n.skipBits=function(e){if(this.bitRemaining>e){var t=e%8;this._byteIndex=this._byteIndex+Math.floor(e/8)+Math.floor((this._bitIndex+t)/8),this._bitIndex=(this._bitIndex+t)%8}else this._byteIndex=this._data.byteLength-1,this._bitIndex=7},n.bits=function(e){if(e>32)throw new Error("len must be less 32");var t=this._data[this._byteIndex],i=Math.min(8-this._bitIndex,e),r=e-i;this._bitIndex+=i;var n=t>>8-this._bitIndex&Math.pow(2,i)-1;return 8===this._bitIndex&&(this._bitIndex=0,this._byteIndex++),r?n<<r|this.bits(r):n},n.ue=function(){var e=this._leadingZeroCount();return this.bits(e+1)-1},n.se=function(){var e=this.ue();return Math.pow(-1,e+1)*Math.ceil(e/2)},n._leadingZeroCount=function(){for(var e=this.bitRemaining,t=0;t<e;t++)if(1===this.bits(1))return 0===this._bitIndex?(this._byteIndex--,this._bitIndex=7):this._bitIndex--,t;return 0},t=e,(i=[{key:"bitRemaining",get:function(){return 8*(this._data.byteLength-this._byteIndex)-this._bitIndex}}])&&I(t.prototype,i),r&&I(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),B=[[1,1],[12,11],[10,11],[16,11],[40,33],[24,11],[20,11],[32,11],[80,33],[18,11],[15,11],[64,33],[160,99],[4,3],[3,2],[2,1]],N={1:"4:2:0",2:"4:2:2",3:"4:4:4"},U={66:"Baseline",77:"Main",88:"Extended",100:"High",110:"High10",122:"High422",244:"High444"},V=[100,110,122,244,44,83,86,118,128,138,144],j=function(){function e(){}return e.parse=function(t){for(var i=new Uint8Array(t.byteLength),r=0,n=0;n<t.byteLength;n++)n>=2&&3===t[n]&&0===t[n-1]&&0===t[n-2]||(i[r]=t[n],r++);var o=new F(i);o.skipBits(8);var s=o.bits(8);o.skipBits(8);var a=o.bits(8);o.ue();var d=1;if(-1!==V.indexOf(s)&&(3===(d=o.ue())&&o.skipBits(1),o.ue(),o.ue(),o.skipBits(1),o.bits(1)))for(var u=3!==d?8:12,f=0;f<u;f++)o.bits(1)&&(f<6?e._skipScalingList(o,16):e._skipScalingList(o,64));o.ue();var h=o.ue();if(0===h)o.ue();else if(1===h){o.bits(1),o.se(),o.se();for(var l=o.ue(),_=0;_<l;_++)o.se()}o.ue(),o.skipBits(1);var c=o.ue(),p=o.ue(),v=o.bits(1);0===v&&o.skipBits(1),o.skipBits(1);var m=0,g=0,y=0,E=0;o.bits(1)&&(m=o.ue(),g=o.ue(),y=o.ue(),E=o.ue());var b=0,S=[1,1];if(o.bits(1)){if(o.bits(1)){var L=o.bits(8);L>0&&L<16?S=B[L-1]:255===L&&(S=[o.bits(8)<<8|o.bits(8),o.bits(8)<<8|o.bits(8)])}if(o.bits(1)&&o.bits(1),o.bits(1)&&(o.bits(4),o.bits(1)&&o.bits(24)),o.bits(1)&&(o.ue(),o.ue()),o.bits(1)){var T=o.bits(32),R=o.bits(32);o.bits(1)&&(b=R/(2*T))}}o=void 0;var w=0,O=0;0===d?(w=1,O=2-v):(w=3===d?1:2,O=(1===d?2:1)*(2-v));var M=16*(c+1),x=16*(p+1)*(2-v);return M-=(m+g)*w,x-=(y+E)*O,{profile:U[s]||"unknown",level:(a/10).toFixed(1),chromaFormat:(d<=3?N[d]:N[1])||"unknown",fps:b,pixelAspectRatio:S,width:M,height:x}},e._skipScalingList=function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.se()+256)%256),i=0===r?i:r},e}();function H(e,t,i){for(var r=new Uint8Array(e,t,i),n=[],o=0,s=r.byteLength;o<s;){if(r[o]<128)n.push(r[o]);else if(r[o]<192);else if(r[o]<224){if(o<s-1&&r[o+1]>>6==2){n.push((31&r[o])<<6|63&r[o+1]),o+=2;continue}}else if(r[o]<240){if(o<s-2&&r[o+1]>>6==2&&r[o+2]>>6==2){n.push((15&r[o])<<12|(63&r[o+1])<<6|63&r[o+2]),o+=3;continue}}else if(r[o]<248&&o<s-3&&r[o+1]>>6==2&&r[o+2]>>6==2&&r[o+3]>>6==2){n.push((7&r[o])<<18|(63&r[o+1])<<12|(63&r[o+2])<<6|63&r[o+3]),o+=4;continue}o++}return String.fromCodePoint.apply(null,n)}var z=function(){function e(){}return e.decode=function(t,i){void 0===i&&(i=0);var r={view:new DataView(t,i),i:0};r.i=0;var n={};try{n[e._read(r)]=e._read(r)}catch(e){}return n},e._read=function(t){var i,r=t.view,n=r.byteLength,o=r.getUint8(t.i);switch(t.i++,o){case 0:return i=r.getFloat64(t.i),t.i+=8,i;case 1:return i=r.getUint8(t.i),t.i++,i;case 2:return e._readString(t);case 3:for(i={};t.i<n-4;){if(e._isObjectEnd(t)){t.i+=3;break}e._readObjProperty(t,i)}return i;case 5:return null;case 8:for(i={},t.i+=4;t.i<n-8;){if(e._isObjectEnd(t)){t.i+=3;break}e._readObjProperty(t,i)}return i;case 10:i=[];var s=r.getUint32(t.i);t.i+=4;for(var a=0;a<s;a++)i.push(e._read(t));return i;case 11:return e._readDate(t);case 12:return e._readLongString(t)}},e._isObjectEnd=function(e){return e.i+2>e.view.byteLength-1||0===e.view.getInt16(e.i)&&9===e.view.getUint8(e.i+2)},e._readObjProperty=function(t,i){var r=e._readString(t),n=e._read(t);i[r]=n},e._readString=function(e){var t,i=e.view.getUint16(e.i);return t=i>0?H(e.view.buffer,e.view.byteOffset+e.i+2,i):"",e.i+=2+i,t},e._readLongString=function(e){var t,i=e.view.getUint32(e.i);return t=i>0?H(e.view.buffer,e.view.byteOffset+e.i+4,i):"",e.i+=4+i,t},e._readDate=function(e){var t=e.view.getFloat64(e.i);e.i+=8;var i=e.view.getInt16(e.i);return e.i+=2,new Date(t+60*i*1e3)},e}(),W=function(){function e(e,t,i){this.tag="FlvDemux",this._eventEmitter=void 0,this._remuxer=void 0,this._naluLengthSize=void 0,this._hasVideo=void 0,this._hasAudio=void 0,this._videoTrack=void 0,this._audioTrack=void 0,this._remuxStat=void 0,this._audioLastDTS=0,this._videoLastDTS=0,this._nonMonotonousTagCache=void 0,this._audioCodec="",this._videoCodec="",this._eventEmitter=e,this._remuxer=t,this._naluLengthSize=4,this._hasVideo=!0,this._hasAudio=!0,this._videoTrack={id:1,type:r.video,codec:"",timescale:1e3,duration:0,samples:[],mp4Samples:[],inputTimescale:1e3,sequenceNumber:0,width:0,height:0,codecWidth:0,codecHeight:0,sps:[],pps:[],pixelRatio:[],profile:"",level:"",chromaFormat:"",fps:0,sampleDuration:0},this._audioTrack={id:2,type:r.audio,codec:"",timescale:1e3,duration:0,samples:[],mp4Samples:[],inputTimescale:1e3,sequenceNumber:0,samplerate:0,channelCount:0,config:[],sampleDuration:0}}var t=e.prototype;return t.append=function(e,t,i){var r=this;this._remuxStat||(this._remuxStat={timeOffset:t,isContinuous:i}),e.length&&(e.forEach((function(e){e.tagType===D.FlvTagType.VIDEO&&r._hasVideo?r._parseVideoData(e):e.tagType===D.FlvTagType.AUDIO&&r._hasAudio?r._parseAudioData(e):e.tagType===D.FlvTagType.SCRIPT&&r._parseScriptTag(e)})),this._remux())},t.setCodecs=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),this._audioCodec=e,this._videoCodec=t},t.flvHead=function(e,t){this._hasAudio=e,this._hasVideo=t},t.destroy=function(){},t.flush=function(){this._remux(!0),this._remuxStat=void 0},t.reset=function(){this._videoTrack.samples=[],this._audioTrack.samples=[],this._audioLastDTS=this._videoLastDTS=0,this._remuxStat=void 0},t._parseScriptTag=function(e){if(e.body){var t=z.decode(e.body.buffer);if(t.timestamp=e.timestamp,t.hasOwnProperty("onMetaData")){var i=t.onMetaData;"number"==typeof i.framerate&&(this._videoTrack.fps=this._videoTrack.fps||i.framerate),u.Log.i(this.tag,"Parsed onMetaData")}this._eventEmitter.emit(n.default.SCRIPT_PARSED,t)}},t._parseVideoData=function(e){if(e.body){var t=e.body[0];e.frameType=(240&t)>>>4;var i=15&t;if(7===i){e.codecId=i;var r=e.body[1];if(e.cts=((255&e.body[2])<<16)+((255&e.body[3])<<8)+(255&e.body[4]),0===r)this._parseAVCDecoderConfigurationRecord(e,5);else if(1===r)this._parseAVCVideoData(e,5);else if(2!==r)return void this._onError(o.ErrorDetails.DEMUX_ERROR,"video packet type error: "+r+" ")}else this._onError(o.ErrorDetails.DEMUX_ERROR,"video codec Unsupported: "+i)}},t._parseAVCDecoderConfigurationRecord=function(e,t){if(e.body){var i=this._videoTrack,r=e.body.buffer,n=e.body.byteLength-t,s=new DataView(r,t,n),a=s.getUint8(0),d=s.getUint8(1);if(1===a&&0!==d)if(this._naluLengthSize=1+(3&s.getUint8(4)),3===this._naluLengthSize||4===this._naluLengthSize){var f=31&s.getUint8(5);if(0===f||f>1)this._onError(o.ErrorDetails.DEMUX_ERROR,"H264 SPS count error: "+f);else{for(var h=6,l=[],_=0;_<f;_++){var c=s.getUint16(h);if(h+=2,0!==c){var p=new Uint8Array(r,t+h,c);h+=c,l.push(p);for(var v=j.parse(p),m=p.subarray(1,4),g="avc1.",y=0;y<3;y++){var E=m[y].toString(16);E.length<2&&(E="0"+E),g+=E}!i.codec||i.width===v.width&&i.height===v.height&&g===i.codec||(this._remux(!0),this._remuxer.resetMoov()),i.sps=l,i.width=v.width,i.height=v.height,i.pixelRatio=v.pixelAspectRatio,v.fps&&(i.fps=v.fps),i.codec=g,i.profile=v.profile,i.level=v.level,i.chromaFormat=v.chromaFormat}}var b=s.getUint8(h);if(0!==b){b>1&&u.Log.w(this.tag,"Flv: Strange AVCDecoderConfigurationRecord: PPS Count = "+b),h++,i.pps=[];for(var S=0;S<b;S++){var L=s.getUint16(h);h+=2;var T=new Uint8Array(r,t+h,L);i.pps.push(T),0!==L&&(h+=L)}u.Log.v(this.tag,"Parsed AVCDecoderConfigurationRecord"),i.sampleDuration=Math.floor(i.timescale/(i.fps||25))}else this._onError(o.ErrorDetails.DEMUX_ERROR,"Flv: Invalid AVCDecoderConfigurationRecord: No PPS")}}else this._onError(o.ErrorDetails.DEMUX_ERROR,"nalu length size error: "+this._naluLengthSize);else this._onError(o.ErrorDetails.DEMUX_ERROR,"AVCDecoderConfiguration error")}},t._parseAVCVideoData=function(e,t,i){if(void 0===i&&(i=!1),e.body){var n=e.body.buffer,o=e.body.byteLength-t,s=new DataView(n,t,o),a=[],d=0,f=0,h=this._naluLengthSize,l=e.timestamp,_=1===e.frameType;if(!i&&l<=this._videoLastDTS&&this._videoLastDTS>0)return u.Log.w(this.tag,"debug Non-monotonous DTS dts:"+l+" last:"+this._videoLastDTS),void this._onNonMonotonous({tag:e,dataOffset:t},r.video);!i&&this._nonMonotonousTagCache&&this._flushNonMonotonousCache(),i&&l<=this._videoLastDTS&&(l=this._videoLastDTS+1);for(var c=l+e.cts;f<o;){if(f+4>=o){u.Log.v(this.tag,"ignore nalu. timestamp = "+e.timestamp+", offset = "+f+", dataSize = "+o);break}var p=s.getUint32(f);if(3===h&&(p>>>=8),p>o-h)return void u.Log.v(this.tag,"ignore nalu. naluSize > dataSize timestamp "+l);var v=new Uint8Array(n,t+f+4,h+p-4);7===e.codecId&&5==(31&s.getUint8(f+h))&&(_=!0),a.push(v),d+=v.byteLength,f+=h+p}if(a.length){var m=this._videoTrack,g={units:a,length:d,dts:l,cts:e.cts,pts:c,streamDTS:e.timestamp,key:_};m.samples.push(g)}this._videoLastDTS=l}},t._parseAudioData=function(e,t){var i;if(void 0===t&&(t=!1),e.body)if(e.body.byteLength<=1)u.Log.v(this.tag,"audio packet no payload!");else{var n=this._audioTrack,s=e.body[1];if(0!==s)if(1===s){var a=e.body.subarray(2),d=e.timestamp;if(i=1024e3/n.samplerate,this._audioLastDTS>0){d=this._audioLastDTS+i;var f=e.timestamp-d,h=5*i;if(f>h)d=e.timestamp;else if(!t&&f<-h)return void this._onNonMonotonous({tag:e},r.audio)}!t&&this._nonMonotonousTagCache&&this._flushNonMonotonousCache();var l={unit:a,length:a.byteLength,dts:d,pts:d,streamDTS:e.timestamp};this._audioLastDTS=d,n.samples.push(l)}else u.Log.v(this.tag,"Unsupported AAC data type "+s);else{if(e.body.byteLength<4)return;var _=function(e,t,i){if(void 0===i&&(i=""),!(e.byteLength<t+3)){var r=(7&e[t+2])<<1|e[t+3]>>>7,n=(120&e[t+3])>>>3,o=[],s=e[t+2]>>>3,a=r,d=i||"mp4a.40."+s;if(!(r<0||r>=P.length||n<0||n>=8))return C.default.isFirefox?r>=6?(s=5,a=r-3):s=2:C.default.isAndroid?s=2:(s=5,"mp4a.40.29"===d||"mp4a.40.5"===d?a=r-3:"mp4a.40.2"===d&&r>=6&&1===n&&(s=2)),o[0]=s<<3|r>>1&7,o[1]=r<<7&128|n<<3,5===s&&(o[1]=o[1]|a>>1&7,o[2]=(1&a)<<7|8,o[3]=0),{config:o,samplerate:P[r],channelCount:n,codec:"mp4a.40."+s,defaultCodec:d}}}(e.body,0,this._audioCodec);_?(n.config=_.config,n.timescale=n.samplerate=_.samplerate,n.channelCount=_.channelCount,n.codec=_.codec,n.defaultCodec=_.defaultCodec,n.sampleDuration=1024e3/n.samplerate):this._onError(o.ErrorDetails.DEMUX_ERROR,"AudioSpecificConfig parse error")}}},t._onNonMonotonous=function(e,t){this._nonMonotonousTagCache||(this._nonMonotonousTagCache={video:[],audio:[]});var i=this._nonMonotonousTagCache[t];if(i.length>10){this._remuxer.flush();var r=this._remuxer.getLastPTS(),n=r.audio;(0===n||r.video>0&&r.video<n)&&(n=r.video),this._videoTrack.samples=[],this._audioTrack.samples=[],this._audioLastDTS=this._videoLastDTS=0,this._remuxStat={isContinuous:!1,timeOffset:n},this._remuxer.resetMoov(),this._remuxer.resetTimeStamp(),u.Log.i(this.tag,"NON_MONOTONOUS reset time"),this._flushNonMonotonousCache()}else i.push(e)},t._flushNonMonotonousCache=function(){if(this._nonMonotonousTagCache){var e=this._nonMonotonousTagCache;for(var t in e)for(var i=e[t];i.length;){var r=i.shift();r&&("video"===t?this._parseAVCVideoData(r.tag,r.dataOffset||0,!0):"audio"===t&&this._parseAudioData(r.tag,!0))}this._nonMonotonousTagCache=void 0}},t._remux=function(e){void 0===e&&(e=!1);var t=this._audioTrack,i=this._videoTrack,r=!0,n=0;if(this._remuxStat&&(r=this._remuxStat.isContinuous,n=this._remuxStat.timeOffset),0!==t.samples.length||0!==i.samples.length){if(e||!(this._hasAudio&&0===t.samples.length||this._hasVideo&&i.samples.length<2))try{this._remuxer.remux(t,i,n,r,e),this._remuxStat=void 0}catch(e){u.Log.e(this.tag,e),this._onError(o.ErrorDetails.REMUX_ERROR,e.message)}}else e&&this._remuxer.flush()},t._onError=function(e,t){this._eventEmitter.emit(n.default.ERROR,{type:o.ErrorTypes.MUX_ERROR,details:e,fatal:!0,info:{reason:t}})},e}(),q=function(){function e(e,t,i){this.tag="Flv",this._eventEmitter=void 0,this._config=void 0,this._extraData=void 0,this._demuxer=void 0,this._remuxer=void 0,this._eventEmitter=e,this._config=t,this._extraData=i}var t=e.prototype;return t.init=function(){var e=this._config,t=this._eventEmitter,i=this._remuxer=new A(t,e);this._demuxer=new W(t,i,e),i.setExtra(this._extraData)},t.setCodecs=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),this._demuxer.setCodecs(e,t)},t.flvHead=function(e,t){this._demuxer.flvHead(e,t)},t.append=function(e,t,i){i||(this._demuxer.reset(),this._remuxer.resetMoov(),this._remuxer.resetTimeStamp()),this._demuxer.append(e,t,i)},t.end=function(){this._demuxer.flush(),this._remuxer.flush(),this._eventEmitter.emit(n.default.LOAD_END)},t.flush=function(){this._demuxer&&this._demuxer.flush()},t.setExtra=function(e){this._extraData=e,this._remuxer&&this._remuxer.setExtra(this._extraData)},t.destroy=function(){},e}();t.default=q},"./src/demux/flv/flv-demuxer-worker.ts":function(e,t,i){"use strict";i.r(t);var r=i("../../node_modules/.pnpm/events@3.3.0/node_modules/events/events.js"),n=i("./src/core/events.ts"),o=i("./src/core/worker-cmd.ts"),s=i("./src/utils/log.ts"),a=i("./src/demux/flv/flv-demuxer-inline.ts");t.default=function(e){var t,i=new r.EventEmitter;i.on(n.default.MEDIA_INFO,(function(t){e.postMessage({event:n.default.MEDIA_INFO,data:t})})),i.on(n.default.ERROR,(function(t){e.postMessage({event:n.default.ERROR,data:t})})),i.on(n.default.SCRIPT_PARSED,(function(t){e.postMessage({event:n.default.SCRIPT_PARSED,data:t})})),i.on(n.default.LOAD_END,(function(t){e.postMessage({event:n.default.LOAD_END,data:t})})),i.on(n.default.MP4_SEGMENT,(function(t){var i={event:n.default.MP4_SEGMENT,data:t},r=[];t.segments.forEach((function(e){r.push(e.payload.buffer)})),e.postMessage(i,r)})),e.addEventListener("message",(function(e){var r=e.data;switch(r.cmd){case o.WorkerCmd.INIT:s.Log.level(r.config.debug),function(e,i,r){(t=new a.default(e,i,r)).init()}(i,r.config,r.data);break;case o.WorkerCmd.DESTROY:t&&t.destroy(),i&&i.removeAllListeners();break;case o.WorkerCmd.APPEND_DATA:t.append(r.tags,r.timeOffset,r.isContinuous);break;case o.WorkerCmd.SET_CODECS:t.setCodecs(r.audioCodec,r.videoCodec);break;case o.WorkerCmd.FLV_HEAD:t.flvHead(r.hasAudio,r.hasVideo);break;case o.WorkerCmd.FLUSH:t.flush();break;case o.WorkerCmd.SET_EXTRA:t.setExtra(r.data);break;case o.WorkerCmd.LOAD_END:t.end()}}))}},"./src/index.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return fe}));var r=i("../../node_modules/.pnpm/events@3.3.0/node_modules/events/events.js"),n=i("./src/utils/log.ts");function o(){return(o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(this,arguments)}var s={webWorker:!0,appendErrorMaxRetry:3,credentials:!1,defaultLiveDelay:-2e3,debug:n.LOG_LEVEL.LEVEL_ERROR,connectionTimeout:1e4,transmissionTimeout:3e4,autoRecoverMedia:!1,autoPlaybackRate:!0},a=function(){function e(){}return e.processConfig=function(e){var t=o({},s);return o(t,e),window.Worker||(t.webWorker=!1),t.debug&&n.Log.level(t.debug),this._initPlayBackRateRule(t),t},e._initPlayBackRateRule=function(e){var t=e.autoPlaybackRateConf;if(t){var i=t.rule;if(i&&Array.isArray(i)&&((i=i.filter((function(e){return e.upper>e.lower&&e.rate>0}))).sort((function(e,t){return t.rate-e.rate})),i.length>1))return t.rule=i,void(e.autoPlaybackRateConf=t)}else{var r=-e.defaultLiveDelay/1e3,n={startDelay:r,interval:.2,rule:[{rate:1.1,lower:r+1,upper:Number.MAX_SAFE_INTEGER},{rate:1,lower:0,upper:r}]};e.autoPlaybackRateConf=n}},e}(),d=i("./src/core/errors.ts"),u=i("./src/core/events.ts"),f=i("../../node_modules/.pnpm/webworkify-webpack@2.1.5/node_modules/webworkify-webpack/index.js"),h=i.n(f);function l(e,t){if(void 0===t)return e;var i=e.split("?");return i.splice(1,0,"?startPts="+t+(i.length>1?"&":"")),i.join("")}var _=function(e){this.url=void 0,this.bitrate=0,this.maxBitrate=0,this.avgBitrate=0,this.qualityType="",this.qualityTypeName="",this.id=0,this.codec="",this.audioCodec="",this.videoCodec="",this.hidden=!1,this.disabledFromAdaptive=!1,this.defaultSelected=!1,this.url=e};function c(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}var p,v=function(){function e(t){var i=this;this._levels=[],this._abrLevels=[],this._default=void 0,e.verify(t)&&(t.adaptationSet[0].representation.forEach((function(e,t){var r,n,o=new _(e.url);if(o.id=e.id||0,o.maxBitrate=e.maxBitrate||0,o.avgBitrate=e.avgBitrate||0,o.bitrate=e.avgBitrate||o.maxBitrate,o.qualityType=e.qualityType||"",o.qualityTypeName=e.qualityTypeName||"",o.codec=e.codec||"",o.codec){var s=(r=o.codec,n={},(r||"").split(/[ ,]+/).forEach((function(e){0===e.indexOf("avc1")&&(n.video=e),0===e.indexOf("mp4a")&&(n.audio=e)})),n);o.audioCodec=s.audio,o.videoCodec=s.video}o.hidden=e.hidden||!1,o.disabledFromAdaptive=e.disabledFromAdaptive||e.disabledFromAdaptive,o.defaultSelected=e.defaultSelected||!1,i._levels.push(o),o.disabledFromAdaptive||i._abrLevels.push(t),o.defaultSelected&&void 0===i._default&&(i._default=t)})),this._levels.sort((function(e,t){return e.bitrate-t.bitrate})))}var t,i,r;return e.verify=function(e){return!!(e&&e.hasOwnProperty("version")&&e.hasOwnProperty("adaptationSet")&&Array.isArray(e.adaptationSet)&&e.adaptationSet.length>0)&&e.adaptationSet.reduce((function(e,t){return!!(e&&t.representation&&t.representation.length)}),!0)},t=e,(i=[{key:"levels",get:function(){return this._levels}},{key:"abrLevels",get:function(){return this._abrLevels}},{key:"default",get:function(){return this._default||0}}])&&c(t.prototype,i),r&&c(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),m=function(){function e(){this.tag="fetch",this._context=void 0,this._callbacks=null,this._controller=null,this._reader=null,this._abort=!1}e.isSupported=function(){return!(!self.fetch||!self.ReadableStream)};var t=e.prototype;return t.load=function(e,t){var i=this;this._context=e,this._callbacks=t;var r=new Headers;e.headers&&e.headers.forEach((function(e){r.append(e.header,e.value)}));var n={method:"GET",headers:r,mode:"cors",cache:"default",referrerPolicy:"no-referrer-when-downgrade",signal:this._getAbortSignal()};e.credentials&&(n.credentials="include"),fetch(e.url,n).then((function(t){if(e.responseUrl=t.url,e.responseHeader=t.headers,i._callbacks&&i._callbacks.onConnect&&i._callbacks.onConnect(t.status),t.ok)return i._abort?void(t.body&&t.body.getReader().cancel()):"arraybuffer"===e.responseType?e.progress?void(t.body&&(i._reader=t.body.getReader(),i._pump(i._reader))):void t.arrayBuffer().then((function(t){i._onEnd(e,t)})):void t.text().then((function(t){i._onEnd(e,t)}));var r=new Error(t.status+" "+t.statusText);i._onError(r)})).catch((function(e){"AbortError"!==e.name&&i._onError(e)}))},t.abort=function(){this._controller?this._controller.abort():this._reader&&(this._reader.cancel(),this._reader=null),this._abort=!0},t.destroy=function(){this._callbacks=null,this.abort()},t._onProgress=function(e,t){this._callbacks&&this._callbacks.onProgress&&this._callbacks.onProgress(t)},t._onEnd=function(e,t){this._callbacks&&this._callbacks.onEnd&&(this._reader=null,this._controller=null,this._callbacks.onEnd(t))},t._onError=function(e){this._callbacks&&this._callbacks.onError&&this._callbacks.onError(e)},t._pump=function(e){var t=this;e.read().then((function(i){if(t._abort)return e.cancel(),null;if(i.done)return t._onEnd(t._context,null),null;var r=i.value.buffer;return t._onProgress(t._context,r),t._pump(e)})).catch((function(e){"AbortError"!==e.name&&t._onError(e)}))},t._getAbortSignal=function(){try{if(AbortController)return this._controller=new AbortController,this._controller.signal}catch(e){return null}return null},e}();!function(e){e.MOZ_CHUNK="moz-chunked-arraybuffer",e.MS_STREAM="ms-stream",e.UNKNOW="unknow",e.UNSUPPORT=""}(p||(p={}));var g,y=function(){function e(){this.tag="xhr",this._xhr=null,this._context=void 0,this._callbacks=null,this._reader=null,this._msBufferOffset=0,this._msBufferUpper=16777216,this._progress=p.UNKNOW,this._xhr=null,this._msBufferOffset=0}e.isSupportedChunk=function(){if(e.supportChunk!==p.UNKNOW)return e.supportChunk;try{var t=new XMLHttpRequest;if(t.open("GET","https://example.com",!0),t.responseType=p.MOZ_CHUNK,t.responseType===p.MOZ_CHUNK)return e.supportChunk=p.MOZ_CHUNK,e.supportChunk}catch(t){e.supportChunk=p.UNSUPPORT}try{var i=new XMLHttpRequest;if(i.open("GET","https://example.com",!0),i.responseType=p.MS_STREAM,i.responseType===p.MS_STREAM)return e.supportChunk=p.MS_STREAM,e.supportChunk}catch(t){e.supportChunk=p.UNSUPPORT}return p.UNSUPPORT};var t=e.prototype;return t.load=function(t,i){if(this._callbacks=i,this._context=t,this._progress=p.UNSUPPORT,t.progress&&"arraybuffer"===t.responseType&&(this._progress=e.isSupportedChunk(),this._progress===p.MS_STREAM)){var r=this._reader=new self.MSStreamReader;r.onprogress=this._msrOnProgress.bind(this),r.onload=this._onLoadEnd.bind(this),r.onerror=this._onError.bind(this)}var n=this._xhr=new XMLHttpRequest;n.open("GET",this._context.url,!0),this._progress===p.MOZ_CHUNK?(n.responseType=p.MOZ_CHUNK,n.onprogress=this._onProgress.bind(this),n.onload=this._onLoadEnd.bind(this)):this._progress===p.MS_STREAM?n.responseType=p.MS_STREAM:(n.responseType=t.responseType||"arraybuffer",n.onload=this._onLoadEnd.bind(this)),n.onreadystatechange=this._onReadyStateChange.bind(this),n.onerror=this._onError.bind(this),n.withCredentials=!!t.credentials,n.send()},t.abort=function(){this._reader&&(1===this._reader.readyState&&this._reader.abort(),this._reader.onprogress=null,this._reader.onload=null,this._reader.onerror=null,this._reader=null),this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,this._xhr.abort(),this._xhr=null)},t.destroy=function(){this._callbacks=null,this.abort()},t._onReadyStateChange=function(e){if(this._xhr){var t=this._xhr;2===t.readyState?(this._context.responseUrl=t.responseURL,this._context.responseHeader=t.getAllResponseHeaders(),this._callbacks&&this._callbacks.onConnect&&this._callbacks.onConnect(t.status),(t.status<200||t.status>299)&&this._onError(new Error("xhr error"))):3===t.readyState&&this._reader&&0===this._reader.readyState&&t.status>=200&&t.status<=299&&this._reader.readAsArrayBuffer(t.response)}},t._onProgress=function(e){if(this._xhr){var t=this._xhr.response;this._callbacks&&this._callbacks.onProgress&&t&&this._callbacks.onProgress(t)}},t._msrOnProgress=function(e){var t=e.target.result;if(t){var i=t.slice(this._msBufferOffset);this._msBufferOffset=t.byteLength,this._callbacks&&this._callbacks.onProgress&&this._callbacks.onProgress(i),t.byteLength>=this._msBufferUpper&&this._onError(new Error("ms buffer too large"))}else this._onError(new Error("ms buffer null"))},t._onLoadEnd=function(e){var t=null,i=this._xhr;!this._progress&&i&&(t=i.response),this._callbacks&&this._callbacks.onEnd(t)},t._onError=function(e){this._callbacks&&this._callbacks.onError&&this._callbacks.onError(e)},e}();function E(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}y.supportChunk=p.UNKNOW;var b=function(){function e(){var e=this;this.tag="loader",this._context=void 0,this._loader=void 0,this._callbacks=void 0,this._config=void 0,this._loaderCallback=void 0,this._stats=void 0,this._retryDelay=0,this._loading=!1,this._aborted=!1,this._requestTimeout=void 0,this._transTimer=void 0,this._retryTimeout=void 0,this._progressTime=0,this._onConnect=function(t){e._requestTimeout&&(clearTimeout(e._requestTimeout),e._requestTimeout=null),e._startTransmissionTimer(),e._stats.httpStatusCode=t,e._stats.firstDataTime=Math.max(e._stats.requestStartTime,performance.now())},this._onProgress=function(t){var i=e._stats;e._progressTime=performance.now(),e._callbacks&&e._callbacks.onProgress&&e._callbacks.onProgress(e,t),i.loadedSize+=t.byteLength},this._onEnd=function(t){e._stopTimer();var i=e._stats;i.totalSize=t?i.loadedSize="string"==typeof t?t.length||0:t.byteLength||0:i.loadedSize,i.loadedTime=Math.max(i.firstDataTime,performance.now()),e._loading=!1,e._callbacks&&e._callbacks.onEnd(e,t)},this._onError=function(t){n.Log.i(e.tag,t),e._stopTimer(),e._destroyInternalLoader();var i=e._stats,r=e._config;e._loading=!1,i.fatalError=!r.maxRetry||i.retryCount>=r.maxRetry||!r.maxRetry,i.errorMessage=t.message||"load error",e._callbacks&&e._callbacks.onError&&e._callbacks.onError(e),i.fatalError||(i.retryCount++,e._callbacks&&(e._retryDelay?(e._retryTimeout=setTimeout(e._loadInternal.bind(e),e._retryDelay),e._retryDelay=2*e._retryDelay):e._loadInternal()))},this._onTimeout=function(){e._loading=!1,e._abortInternal();var t=new Error("timeout");e._onError(t)},this._config={useFetch:!1,connectionTimeout:0,transmissionTimeout:0,maxRetry:0,retryDelay:0},this._loaderCallback={onConnect:this._onConnect,onProgress:this._onProgress,onEnd:this._onEnd,onError:this._onError}}var t,i,r,o=e.prototype;return o.load=function(e,t,i){this._context=e,this._callbacks=t,this._config=i||this._config,this._stats={requestStartTime:performance.now(),retryCount:0,loadedSize:0,httpStatusCode:0,firstDataTime:0,loadedTime:0,totalSize:0,errorMessage:"",fatalError:!1},this._config.retryDelay&&(this._retryDelay=this._config.retryDelay),this._loadInternal()},o.abort=function(){this._stopTimer(),this._abortInternal()},o.destroy=function(){this._stopTimer(),this._abortInternal(),this._destroyInternalLoader(),this._callbacks=void 0},o._getInternalLoader=function(e){return void 0!==g||(g=null,m.isSupported()?g=m:y.isSupportedChunk()&&(g=y)),g},o._destroyInternalLoader=function(){this._loader&&(this._loader.destroy(),this._loader=void 0)},o._loadInternal=function(){this._loading=!0,this._aborted=!1;var e=this._stats;e.httpStatusCode=0,e.firstDataTime=0,e.loadedSize=0,this._retryTimeout&&(clearTimeout(this._retryTimeout),this._retryTimeout=null),this._context.progress?this._loader=new(this._getInternalLoader(!!this._config.useFetch)):this._loader=new y,this._loader&&(this._config.connectionTimeout&&(this._requestTimeout=setTimeout(this._onTimeout,this._config.connectionTimeout)),this._loader.load(this._context,this._loaderCallback))},o._abortInternal=function(){this._callbacks&&this._callbacks.onAbort&&!this._aborted&&this._loading&&this._callbacks.onAbort(this),this._aborted=!0,this._loader&&this._loader.abort()},o._stopTimer=function(){this._requestTimeout&&(clearTimeout(this._requestTimeout),this._requestTimeout=null),this._retryTimeout&&(clearTimeout(this._retryTimeout),this._retryTimeout=null),this._stopTransmissionTimer()},o._startTransmissionTimer=function(){var e=this;this._stopTransmissionTimer(),this._progressTime=performance.now();var t=this._config.transmissionTimeout||0;t&&(this._transTimer=setInterval((function(){performance.now()-e._progressTime>t&&e._onTimeout()}),1e3))},o._stopTransmissionTimer=function(){this._transTimer&&(clearInterval(this._transTimer),this._transTimer=null)},t=e,(i=[{key:"stats",get:function(){return this._stats}},{key:"context",get:function(){return this._context}}])&&E(t.prototype,i),r&&E(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),S=function(){function e(){var e=this;this._context=void 0,this._result=void 0,this._callback=void 0,this._loader=void 0,this._loaderConf=void 0,this._loaderCallbacks=void 0,this._timer=void 0,this._startTime=0,this._testEnd=function(){e._stopTimer(),e._loader&&e._loader.destroy(),e._context&&e._result&&e._callback&&(e._result.firstPackageDuration=Math.round(e._result.firstPackageDuration),e._result.duration=Math.round(performance.now()-e._startTime),e._callback.onEnd(e._context,e._result))},this._onProgress=function(t,i){e._result&&(e._result.firstPackageDuration=t.stats.firstDataTime?t.stats.firstDataTime-t.stats.requestStartTime:0,e._result.loaded=t.stats.loadedSize)},this._onLoaderError=function(){e._result&&(e._result.succeeded=!1),e._testEnd()},this._onLoaderEnd=function(){e._testEnd()},this._onAbort=function(){},this._loaderConf={connectionTimeout:0,transmissionTimeout:0,maxRetry:0,retryDelay:0,useFetch:!0},this._loaderCallbacks={onProgress:this._onProgress,onError:this._onLoaderError,onEnd:this._onLoaderEnd,onAbort:this._onAbort}}var t=e.prototype;return t.start=function(e,t){this._context=e,this._callback=t,this._result={loaded:0,duration:0,firstPackageDuration:0,succeeded:!0},this._startTime=performance.now(),this._loader&&this._loader.destroy();var i=Math.min(1e4,e.timeout);this._loaderConf.connectionTimeout=i;var r={url:e.url,progress:!0,responseType:"arraybuffer"};this._loader=new b,this._startTimer(i),this._loader.load(r,this._loaderCallbacks,this._loaderConf)},t.cancel=function(){this._stopTimer(),this._loader&&this._loader.destroy()},t.destroy=function(){this.cancel()},t._startTimer=function(e){var t=this;this._timer=setTimeout((function(){return t._testEnd()}),e)},t._stopTimer=function(){clearTimeout(this._timer)},e}();function L(){return(L=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(this,arguments)}function T(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}function R(e,t){return(R=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var w={stableBufferDiffThresholdSecond:.15,stableBufferIntervalMs:2e3,speedTestTimeoutMs:500,generateSpeedGapMs:3e3,bufferCheckIntervalMs:500,smoothedSpeedUtilizationRatio:.8,smallSpeedToBitrateRatio:.4,enoughSpeedToBitrateRatio:.9,bufferLowerLimitSecond:.6,recentBufferedSize:16,smoothedSpeedRatio:.9,isSpeedFullyUsed:!0},O=function(e){var t,i;function r(){var t;return(t=e.call(this)||this)._conf=void 0,t._pastBuffer=void 0,t._levels=void 0,t._current=0,t._next=0,t._stableBufferStartTime=performance.now(),t._speedTester=new S,t._generatedSpeed=0,t._lastCheckBuffer=0,t._lastSpeed=0,t._timer=void 0,t}i=e,(t=r).prototype=Object.create(i.prototype),t.prototype.constructor=t,R(t,i);var o,s,a,d=r.prototype;return d.init=function(e,t,i){var r=this;this._conf=L({},w),L(this._conf,i),n.Log.i("algorithm-simple","init",e,i,this._conf),this._levels=e.levels.slice(0),this._next=e.default,this._pastBuffer=[.1],t&&(this._timer=setInterval((function(){r._checkBuffer(t)}),this._conf.bufferCheckIntervalMs))},d.setAvailableBitrates=function(e){},d.onGOP=function(e,t,i){var r=t/Math.max(i,.05)*8/1024;n.Log.v("algorithm-simple","buffered: "+e.toFixed(2)+", size: "+t+", time: "+i.toFixed(2)),this._next=this._nextRateIndex(r,e)},d.onLevelLoad=function(e){this._current=Math.max(0,e)},d.destroy=function(){this._speedTester.destroy(),clearInterval(this._timer)},d._updateStableBuffer=function(e){var t=e-this._lastCheckBuffer,i=t/e,r=performance.now();return(t<-this._conf.stableBufferDiffThresholdSecond||i<-.2)&&(n.Log.v("algorithm-simple","bufferDiffDown: "+t.toFixed(2)+"s, diffRatio: "+i.toFixed(2)),this._stableBufferStartTime=Math.max(r,this._stableBufferStartTime)),t>this._conf.stableBufferDiffThresholdSecond&&r-this._stableBufferStartTime+this._conf.bufferCheckIntervalMs>this._conf.stableBufferIntervalMs&&(this._stableBufferStartTime=Math.max(r-2*this._conf.bufferCheckIntervalMs,this._stableBufferStartTime+2*this._conf.bufferCheckIntervalMs),n.Log.v("algorithm-simple","bufferDiffUp: "+t.toFixed(2)+"s")),this._lastCheckBuffer=e,r-this._stableBufferStartTime>this._conf.stableBufferIntervalMs},d._isSpeedFullyUsed=function(){return this._conf.isSpeedFullyUsed},d._checkBuffer=function(e){var t=e.bufferedSec(),i=this._updateStableBuffer(t);this._isSpeedFullyUsed()?i&&this._current+1<this._levels.length?this._generatedSpeed=this._levels[this._current+1].bitrate:this._generatedSpeed=0:i&&this._current+1<this._levels.length&&(this._startTesting(e),this._stableBufferStartTime=performance.now()+this._conf.generateSpeedGapMs),this._pastBuffer.push(t),this._pastBuffer.length>this._conf.recentBufferedSize&&this._pastBuffer.shift()},d._startTesting=function(e){var t=this;n.Log.v("algorithm-simple","start speed testing on index: "+(this._current+1));var i=e.downloadSize(),r=this._levels[this._current+1].bitrate;this._speedTester.start({url:this._levels[this._current+1].url,timeout:this._conf.speedTestTimeoutMs},{onEnd:function(o,s){var a=e.downloadSize()-i;if(s.succeeded&&s.duration>0&&s.firstPackageDuration>0){var d=8*(a+s.loaded)/s.duration;n.Log.v("algorithm-simple","testSpeed: "+d.toFixed(0)),d>=r&&(t._generatedSpeed=r)}n.Log.v("algorithm-simple","succeeded: "+s.succeeded+", firstPackageDuration: "+s.firstPackageDuration+", originalDownloadSize: "+a+", downloadSize: "+s.loaded+", downloadTime: "+s.duration)}})},d._quantization=function(e){for(var t=0,i=this._levels.length-1;i>=0;i--)if(e>=this._levels[i].bitrate){t=i;break}return t},d._nextRateIndex=function(e,t){var i=this._nextRateBySpeedAndBuffered(e,t);return i!=this._current&&(this._stableBufferStartTime=performance.now()+this._conf.generateSpeedGapMs),i<this._current?(this._speedTester.cancel(),this._generatedSpeed=0,this._lastSpeed=e,this._pastBuffer=[t]):this._lastSpeed=this._getSmoothedSpeed(e),i},d._getSmoothedSpeed=function(e){return this._lastSpeed>0?e*(1-this._conf.smoothedSpeedRatio)+this._lastSpeed*this._conf.smoothedSpeedRatio:e},d._getPredictedBuffer=function(e){return e+(e-Math.max.apply(Math,this._pastBuffer))},d._getBufferSpeed=function(e){var t=Math.max.apply(Math,this._pastBuffer);return(1+(e-t)/t)*this._levels[this._current].bitrate},d._isSpeedTooSmall=function(e){return e/this._levels[this._current].bitrate<this._conf.smallSpeedToBitrateRatio},d._isSpeedEnough=function(e){return e/this._levels[this._current].bitrate>this._conf.enoughSpeedToBitrateRatio},d._nextRateBySpeedAndBuffered=function(e,t){var i=this._getBufferSpeed(t),r=this._getSmoothedSpeed(e);n.Log.v("algorithm-simple","gopSpeed: "+e.toFixed(0)+", smoothedSpeed: "+r.toFixed(0));var o=this._getPredictedBuffer(t);n.Log.v("algorithm-simple","bufferSpeed: "+i.toFixed(0)+", predictedBuffered: "+o.toFixed(1));var s=this._current;return o<this._conf.bufferLowerLimitSecond||this._isSpeedTooSmall(i)?s=Math.min(this._current,this._quantization(i)):this._isSpeedEnough(i)&&(this._generatedSpeed>0?(n.Log.i("algorithm-simple","generatedSpeed used"),s=this._quantization(this._generatedSpeed),this._generatedSpeed=0):s=this._quantization(r*this._conf.smoothedSpeedUtilizationRatio),s=Math.min(this._current+1,Math.max(s,this._current))),s},o=r,(s=[{key:"nextLevel",get:function(){return n.Log.v("algorithm-simple","nextLevel: "+this._next),this._next}}])&&T(o.prototype,s),a&&T(o,a),Object.defineProperty(o,"prototype",{writable:!1}),r}(r.EventEmitter);function M(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}var x=function(){function e(e,t,i,r){var n=this;this._eventEmitter=void 0,this._config=void 0,this._media=void 0,this._next=0,this._downloadSizeTotal=0,this._downloadSize=0,this._downloadStartTime=0,this._keyCount=0,this._index=0,this._alg=void 0,this._manifest=void 0,this._autoLevelEnabled=!1,this._eventEmitter=e,this._config=t,this._media=i,this._manifest=new v(r);var o={bufferedSec:function(){return n._media.bufferedSec()},downloadSize:function(){return n._downloadSizeTotal}};this._alg=new O,this._alg.init(this._manifest,o),this._autoLevelEnabled=this._manifest.abrLevels.length>0}var t,i,r,n=e.prototype;return n.init=function(){this._downloadSizeTotal=0,this._downloadSize=0,this._downloadStartTime=performance.now(),this._keyCount=0,this._index=this._next=0,this.current&&(this._autoLevelEnabled&&(this._index=this._next=this._alg.nextLevel),this._eventEmitter.emit(u.default.MANIFEST_PARSED,{levels:this._manifest.levels,currentLevel:this._index}))},n.destory=function(){this._alg&&(this._alg.destroy(),this._alg.removeAllListeners())},n.onLoaderChunk=function(e){this._downloadSize+=e,this._downloadSizeTotal+=e},n.onLevelLoad=function(e){this._manifest.levels.length&&e>=0&&e<this._manifest.levels.length&&(this._keyCount=0,this._index=e,this._downloadStartTime=performance.now(),this._downloadSize=0,this._alg.onLevelLoad(e))},n.onKeyFrame=function(e){var t=this._manifest.levels;if(this._keyCount++,(this._alg||this._next!==this._index)&&this._keyCount>1&&t){var i=this._index;if(this._next!==this._index)i=this._next;else{if(!this._autoLevelEnabled)return;var r=performance.now();this._alg.onGOP(this._media.bufferedSec(),this._downloadSize,(r-this._downloadStartTime)/1e3),this._downloadSize=0,this._downloadStartTime=r,this._next=i=this._alg.nextLevel}if(i!==this._index)return{url:this._getRequestUrl(i,e),level:i,timestamp:e}}},n._getRequestUrl=function(e,t){var i="",r=this._manifest.levels[e];return r&&(i=r.url),l(i,t||this._config.defaultLiveDelay)},t=e,(i=[{key:"autoLevelEnabled",get:function(){return this._autoLevelEnabled}},{key:"levels",get:function(){return this._manifest.levels}},{key:"nextLevel",get:function(){return"number"==typeof this._next?this._next:this._index},set:function(e){e>=0&&this._manifest.levels.length>e?(this._autoLevelEnabled=!1,this._next=e):-1===e&&(this._autoLevelEnabled=!0)}},{key:"currentLevel",get:function(){return this._index},set:function(e){e>=0&&this._manifest.levels.length>e?(this._autoLevelEnabled=!1,this._index=this._next=e):-1===e&&(this._autoLevelEnabled=!0)}},{key:"current",get:function(){return this._manifest.levels[this._index]}}])&&M(t.prototype,i),r&&M(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),k=i("./src/demux/flv/flv-demuxer-inline.ts");function A(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}var D=function(){function e(t){void 0===t&&(t=0),this._size=void 0,this._readOffset=0,this._writeOffset=0,this._storage=void 0,this._cache=void 0,this._size=t>0?t:e.DEFAULT_CACHE_SIZE,this._storage=new ArrayBuffer(this._size),this._cache=new Uint8Array(this._storage)}var t,i,r,n=e.prototype;return n.put=function(e){if(this._readOffset===this._writeOffset&&(this._readOffset=this._writeOffset=0),this._writeOffset+e.byteLength>this._size){var t=this._writeOffset+e.byteLength-this._readOffset;t>this._size?(this._collateCache(),this.expandCache(t)):this._collateCache()}this._cache.set(e,this._writeOffset),this._writeOffset+=e.byteLength},n.get=function(e){if(e+this._readOffset>this._writeOffset)return null;var t=null;if(this._cache.slice)t=this._cache.slice(this._readOffset,this._readOffset+e);else{var i=this._cache.byteOffset+this._readOffset;t=new Uint8Array(this._storage.slice(i,i+e))}return this._readOffset+=e,t},n.read=function(e){return e+this._readOffset>this._writeOffset?null:new Uint8Array(this._storage,this._readOffset,e)},n.skip=function(e){e+this._readOffset>this._writeOffset||(this._readOffset+=e)},n.clear=function(){this._readOffset=this._writeOffset=0},n.expandCache=function(t){if(void 0===t&&(t=0),this._size=Math.max(2*this._size,t),this._size>=e.MAX_CACHE_SIZE)throw new Error("max cache size");0===this._readOffset&&0===this._writeOffset?this._storage=new ArrayBuffer(this._size):this._storage=this._transfer(this._storage,this._size),this._cache=new Uint8Array(this._storage)},n._collateCache=function(){var e=new Uint8Array(this._storage,this._readOffset,this._writeOffset-this._readOffset);this._cache.set(e),this._writeOffset-=this._readOffset,this._readOffset=0},n._transfer=function(e,t){if(!(e instanceof ArrayBuffer))throw new TypeError("Source must be an instance of ArrayBuffer");if(t<=e.byteLength)return e.slice(0,t);var i=new Uint8Array(e),r=new Uint8Array(new ArrayBuffer(t));return r.set(i),r.buffer},t=e,(i=[{key:"unreadLen",get:function(){return this._writeOffset-this._readOffset}}])&&A(t.prototype,i),r&&A(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();D.MAX_CACHE_SIZE=104857600,D.DEFAULT_CACHE_SIZE=3145728;var C=D,P=i("./src/types/flv-object.ts"),I=function(){function e(e,t){this._eventEmitter=void 0,this._cache=void 0,this._tag=void 0,this._result=void 0,this._parseLen=0,this._parseFunc=void 0,this._onFlvKeyframe=void 0,this._eventEmitter=e,this._onFlvKeyframe=t,this._cache=new C,this._parseLen=P.FlvSize.FLV_HEAD_LEN,this._parseFunc=this._parseFlvHead,this._result={list:[]}}var t=e.prototype;return t.reset=function(){this._parseLen=P.FlvSize.FLV_HEAD_LEN,this._parseFunc=this._parseFlvHead,this._cache.clear(),this._tag=void 0,this._result.list=[],this._result.callbackResult=void 0},t.processing=function(e){for(this._cache.put(new Uint8Array(e));this._cache.unreadLen>this._parseLen;)this._parseFunc();var t={list:this._result.list.splice(0),callbackResult:this._result.callbackResult};return this._result.callbackResult=void 0,t},t._parseFlvHead=function(){var e=this._cache.read(P.FlvSize.FLV_HEAD_LEN);e&&(70===e[0]&&76===e[1]&&86===e[2]&&1===e[3]||this._eventEmitter.emit(u.default.ERROR,{type:d.ErrorTypes.MUX_ERROR,details:d.ErrorDetails.DEMUX_ERROR,fatal:!0,info:{reason:"flv wrong head"}}),this._eventEmitter.emit(u.default.FLV_HEAD,{hasAudio:(4&e[4])>>>2,hasVideo:1&e[4]}),this._cache.skip(P.FlvSize.FLV_HEAD_LEN),this._parseLen=P.FlvSize.FLV_TAG_HEAD_LEN,this._parseFunc=this._parseFlvTagHead)},t._parseFlvTagHead=function(){this._tag=new P.FlvTag;var e=this._cache.read(P.FlvSize.FLV_TAG_HEAD_LEN);e&&(this._tag.tagType=e[0],this._tag.dataSize=((255&e[1])<<16)+((255&e[2])<<8)+(255&e[3]),this._tag.timestamp=((255&e[7])<<24)+((255&e[4])<<16)+((255&e[5])<<8)+(255&e[6]),this._cache.skip(P.FlvSize.FLV_TAG_HEAD_LEN),this._tag.tagType===P.FlvTagType.VIDEO?(this._parseFunc=this._detectKeyFrame,this._parseLen=P.FlvSize.AVC_KEY_FRAME_CHECK_LEN):(this._parseFunc=this._parseFlvTag,this._parseLen=this._tag.dataSize+P.FlvSize.FLV_TAG_SIZE_LEN))},t._detectKeyFrame=function(){var e=this._cache.read(2);if(e&&this._tag){var t=(240&e[0])>>>4,i=e[1];this._parseFunc=this._parseFlvTag,this._parseLen=this._tag.dataSize+P.FlvSize.FLV_TAG_SIZE_LEN,1===t&&1===i&&this._onFlvKeyframe&&(this._result.callbackResult=this._onFlvKeyframe(this._tag.timestamp),this._result.callbackResult&&(this._parseLen=P.FlvSize.FLV_HEAD_LEN,this._parseFunc=this._parseFlvHead,this._cache.clear(),this._tag=void 0))}},t._parseFlvTag=function(){var e=this._tag;e&&(e.tagType!==P.FlvTagType.SCRIPT&&e.tagType!==P.FlvTagType.AUDIO&&e.tagType!==P.FlvTagType.VIDEO||(e.body=this._cache.get(e.dataSize),this._cache.skip(4),e&&this._result.list.push(e),this._tag=void 0),this._parseFunc=this._parseFlvTagHead,this._parseLen=P.FlvSize.FLV_TAG_HEAD_LEN)},e}(),F="startLoadStream",B="loader-chunk-arrival",N="keyFrame",U=i("./src/core/worker-cmd.ts");function V(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}function j(e,t){return(j=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var H=new RegExp("^(http|https)://"),z=function(e){var t,i;function o(t,i){var o;(o=e.call(this)||this)._config=void 0,o._media=void 0,o._w=void 0,o._flv=void 0,o._eventEmitter=void 0,o._loader=void 0,o._loaderConf=void 0,o._loaderCallbacks=void 0,o._multirate=void 0,o._isContinuous=void 0,o._remuxId=void 0,o._baseTimeSec=0,o._tagDump=void 0,o._currentUrl=void 0,o._isAbr=!1,o._progressTime=0,o._src=void 0,o._audioCodec="",o._onWorkerEvent=function(e){var t=e.data;o._onEvent(t.event,t.data)},o._flvKeyframeCallback=function(e){return o._media.hasStreamTime||o._media.updateStreamTime(e/1e3,0),o._multirate?o._multirate.onKeyFrame(e):void 0},o._onEvent=function(e,t){switch(e){case u.default.FLV_HEAD:o._w?o._w.postMessage({cmd:U.WorkerCmd.FLV_HEAD,hasAudio:t.hasAudio,hasVideo:t.hasVideo}):o._flv&&o._flv.flvHead(t.hasAudio,t.hasVideo);break;case u.default.MEDIA_INFO:o.emit(u.default.MEDIA_INFO,t);break;case u.default.MP4_SEGMENT:var i=t;if(i.extra&&i.extra.remuxId!==o._remuxId)break;i.segments.forEach((function(e){"audio"===e.type&&e.startDTS>o._baseTimeSec&&o._media.updateStreamTime(e.streamDTS,e.startDTS)})),o.emit(u.default.MP4_SEGMENT,i);break;default:o.emit(e,t)}},o._onLoaderProgress=function(e,t){if(t instanceof ArrayBuffer){o._multirate&&o._multirate.onLoaderChunk(t.byteLength),o.emit(u.default.REPORT,{type:B,byteLength:t.byteLength,timeCost:performance.now()-o._progressTime||e.stats.requestStartTime,header:e.context.responseHeader}),o._progressTime=performance.now();var i=o._tagDump.processing(t);o._append(i.list,o._baseTimeSec,o._isContinuous),o._isContinuous=!0,i.callbackResult&&(o._tagDump&&o._tagDump.reset(),o._baseTimeSec=i.callbackResult.timestamp&&o._media.getLocalTime(i.callbackResult.timestamp/1e3)||0,o.emit(u.default.LEVEL_SWITCHING,{level:i.callbackResult.level,startSec:o._baseTimeSec,smooth:!0}),o._load(i.callbackResult.url,i.callbackResult.level))}},o._onLoaderAbort=function(){},o._onLoaderError=function(e){if(e.stats.fatalError){var t={type:d.ErrorTypes.NETWORK_ERROR,details:"timeout"===e.stats.errorMessage?d.ErrorDetails.LOAD_ERROR_TIMEOUT:d.ErrorDetails.LOAD_ERROR,fatal:!0,info:{url:e.context.url,httpStatusCode:e.stats.httpStatusCode,reason:e.stats.errorMessage}};o.emit(u.default.ERROR,t)}},o._onLoaderEnd=function(){o._w?o._w.postMessage({cmd:U.WorkerCmd.LOAD_END}):o._flv&&o._flv.end()},o._config=t,o._media=i,o._loaderConf={connectionTimeout:o._config.connectionTimeout,transmissionTimeout:o._config.transmissionTimeout,maxRetry:0,retryDelay:0,useFetch:!0},o._loaderCallbacks={onProgress:o._onLoaderProgress,onError:o._onLoaderError,onEnd:o._onLoaderEnd,onAbort:o._onLoaderAbort},o._isContinuous=!1,o._remuxId=1;var s=o._eventEmitter=new r.EventEmitter;return s.on(u.default.MEDIA_INFO,(function(e){o._onEvent(u.default.MEDIA_INFO,e)})),s.on(u.default.SCRIPT_PARSED,(function(e){o._onEvent(u.default.SCRIPT_PARSED,e)})),s.on(u.default.MANIFEST_PARSED,(function(e){o._onEvent(u.default.MANIFEST_PARSED,e)})),s.on(u.default.MP4_SEGMENT,(function(e){o._onEvent(u.default.MP4_SEGMENT,e)})),s.on(u.default.ERROR,(function(e){o._onEvent(u.default.ERROR,e)})),s.on(u.default.FLV_HEAD,(function(e){o._onEvent(u.default.FLV_HEAD,e)})),o._tagDump=new I(o._eventEmitter,o._flvKeyframeCallback),o._config.webWorker&&(n.Log.i("LasMain","webWorker"),o._w=h()("./src/demux/flv/flv-demuxer-worker.ts"),o._w)?(o._w.addEventListener("message",o._onWorkerEvent),o._w.postMessage({cmd:U.WorkerCmd.INIT,config:o._config,data:{remuxId:o._remuxId}}),function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(o)):(o._flv=new k.default(s,o._config,{remuxId:o._remuxId}),o._flv.init(),o)}i=e,(t=o).prototype=Object.create(i.prototype),t.prototype.constructor=t,j(t,i);var s,a,f,_=o.prototype;return _.init=function(e,t){if(void 0===t&&(t=""),this._src=e,this._audioCodec=t,"string"==typeof e&&!H.test(e))try{this._src=JSON.parse(e)}catch(e){return void this.emit(u.default.ERROR,{type:d.ErrorTypes.OTHER_ERROR,details:d.ErrorDetails.MANIFEST_ERROR,fatal:!0,info:{reason:"manifest parse error"}})}this._src?(v.verify(this._src)&&(this._isAbr=!0),this._isAbr&&!this._multirate&&(this._multirate=new x(this._eventEmitter,this._config,this._media,this._src),this._multirate.init())):this.emit(u.default.ERROR,{type:d.ErrorTypes.OTHER_ERROR,details:d.ErrorDetails.MANIFEST_ERROR,fatal:!0,info:{reason:"src empty"}})},_.load=function(){var e=this._multirate;if(e){var t=e.levels[e.currentLevel];t?this._load(l(t.url,this._config.defaultLiveDelay),e.currentLevel):this.emit(u.default.ERROR,{type:d.ErrorTypes.OTHER_ERROR,details:d.ErrorDetails.MANIFEST_ERROR,fatal:!0,info:{reason:"manifest parse error"}})}else this._load(this._src)},_.destroy=function(){this._destroyLoader(),this._w&&(this._w.postMessage({cmd:U.WorkerCmd.DESTROY}),this._w.removeEventListener("message",this._onWorkerEvent),this._w.terminate()),this._flv&&(this._flv.destroy(),this._flv=void 0),this._multirate&&this._multirate.destory();var e=this._eventEmitter;e&&e.removeAllListeners()},_._destroyLoader=function(){this._loader&&(n.Log.i("LasMain","destroy loader"),this._loader.destroy(),this._loader.abort(),this._loader=void 0)},_._load=function(e,t){void 0===t&&(t=0),this._destroyLoader(),this._multirate&&this._multirate.onLevelLoad(t),this._currentUrl=e;var i=this.levels[t];i&&this._updateCodecs(this._audioCodec||i.audioCodec,i.videoCodec),this.emit(u.default.REPORT,{type:F,url:e,sync:this._baseTimeSec,index:t,bitrate:i?i.bitrate:0}),this._loader||(this._loader=new b);var r={url:e,progress:!0,responseType:"arraybuffer",credentials:this._config.credentials};this._loader instanceof b&&this._loader.load(r,this._loaderCallbacks,this._loaderConf)},_._append=function(e,t,i){this._w?this._w.postMessage({cmd:U.WorkerCmd.APPEND_DATA,tags:e,timeOffset:t||0,isContinuous:i}):this._flv&&this._flv.append(e,t||0,i)},_._updateCodecs=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),this._w?this._w.postMessage({cmd:U.WorkerCmd.SET_CODECS,audioCodec:e,videoCodec:t}):this._flv&&this._flv.setCodecs(e,t)},_._refreshRemuxId=function(){this._remuxId++;var e={remuxId:this._remuxId};this._w?this._w.postMessage({cmd:U.WorkerCmd.SET_EXTRA,data:e}):this._flv&&this._flv.setExtra(e)},s=o,(a=[{key:"autoLevelEnabled",get:function(){return!!this._multirate&&this._multirate.autoLevelEnabled}},{key:"levels",get:function(){return this._multirate?this._multirate.levels:[]}},{key:"nextLevel",get:function(){return this._multirate?this._multirate.nextLevel:0},set:function(e){var t=this._multirate;t&&(t.nextLevel=e)}},{key:"currentLevel",get:function(){return this._multirate?this._multirate.currentLevel:0},set:function(e){var t=this._multirate;if(t){var i=e>=0||e!==t.currentLevel;t.currentLevel=e;var r=t.levels[t.currentLevel];i&&r&&(this._currentUrl=l(r.url,this._config.defaultLiveDelay),this._refreshRemuxId(),this._isContinuous=!1,this._tagDump&&this._tagDump.reset(),this._baseTimeSec=this._media.currentTime,this.emit(u.default.LEVEL_SWITCHING,{level:t.currentLevel,startSec:this._baseTimeSec,smooth:!1}),this._load(this._currentUrl,t.currentLevel))}}}])&&V(s.prototype,a),f&&V(s,f),Object.defineProperty(s,"prototype",{writable:!1}),o}(r.EventEmitter);function W(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}var q=function(){function e(){this._video=void 0,this._mse=void 0,this._streamTime=0,this._localTime=0}var t,i,r,n=e.prototype;return n.reset=function(){this._streamTime=0,this._localTime=0},n.attachVideo=function(e){this._video=e},n.attachMSE=function(e){this._mse=e},n.isTimeinBuffered=function(e){if(this._video)for(var t=this._video.buffered,i=0;i<t.length;i++)if(e>=t.start(i)&&e<t.end(i))return!0;return!1},n.bufferedSec=function(){return this._video&&this._video.buffered.length>0?Math.max(0,this._video.buffered.end(this._video.buffered.length-1)-this._video.currentTime):0},n.bufferedSecByType=function(e){return this._mse&&this._video&&this._mse.bufferedEndByType(e)>0?this._mse.bufferedEndByType(e)-this._video.currentTime:0},n.mseBufferedSecByType=function(e){return this._mse?this._mse.bufferedByType(e):{start:0,end:0}},n.bufferSliceNumByType=function(e){return this._mse?this._mse.bufferSliceNumByType(e):0},n.pendingNum=function(){return this._mse?this._mse.pendingNum():0},n.pendingSecByType=function(e){return this._mse?this._mse.pendingSecByType(e):0},n.currentBuffer=function(e){if(this._video)for(var t=this._video.buffered,i=0;i<t.length;i++){var r=t.start(i),n=t.end(i);if(r<=e&&e<n)return{start:r,end:n}}},n.nextBuffer=function(e){if(this._video)for(var t=this._video.buffered,i=0;i<t.length;i++){var r=t.start(i),n=t.end(i);if(r>e)return{start:r,end:n}}},n.updateStreamTime=function(e,t){this._streamTime=e,this._localTime=t},n.getLocalTime=function(e){if(this._streamTime)return e-this._streamTime+this._localTime},t=e,(i=[{key:"hasStreamTime",get:function(){return!!this._streamTime}},{key:"video",get:function(){return this._video}},{key:"mse",get:function(){return this._mse}},{key:"mseReadyState",get:function(){return this._mse?this._mse.readyState:"closed"}},{key:"videoReadyState",get:function(){return this._video?this._video.readyState:0}},{key:"currentTime",get:function(){return this._video?this._video.currentTime:0}}])&&W(t.prototype,i),r&&W(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function G(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}function Q(e,t){return(Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var K=function(e){var t,i;function r(t){var i;return(i=e.call(this)||this).video=void 0,i._sourceBuffer=void 0,i.tag="MSE",i._config=void 0,i._mediaSource=null,i._mimeCodec=void 0,i._cleanUpTask=void 0,i._appendQueue=void 0,i._hasVideo=void 0,i._hasAudio=void 0,i._endOfData=!1,i._appendEnabled=void 0,i._duration=null,i._appendError=0,i._appendBufferError=!1,i._sbHandler={},i._onSourceOpen=function(){n.Log.i(i.tag,"MediaSource onSourceOpen"),i._mediaSource&&(i._mediaSource.removeEventListener("sourceopen",i._onSourceOpen),i._checkSourceBuffer(),i.refresh(),i.emit("source_open"))},i._onSourceEnded=function(){n.Log.i(i.tag,"MediaSource onSourceEnded")},i._onSourceClose=function(){n.Log.i(i.tag,"MediaSource onSourceClose"),i._mediaSource&&(i._mediaSource.removeEventListener("sourceopen",i._onSourceOpen),i._mediaSource.removeEventListener("sourceended",i._onSourceEnded),i._mediaSource.removeEventListener("sourceclose",i._onSourceClose))},i._onSourceBufferUpdateEnd=function(e){i._update(e),i._endOfData&&i._endOfStream(),i.emit("updateend")},i._onSourceBufferError=function(e){n.Log.e(i.tag,"SourceBuffer Error: "+e),i.emit(u.default.ERROR,{type:d.ErrorTypes.MSE_ERROR,details:d.ErrorDetails.SOURCEBUFFER_ERROR,fatal:!0,info:{reason:"source buffer error"}})},i._config=t,i._hasVideo=!1,i._hasAudio=!1,i._appendQueue={video:[],audio:[],audiovideo:[]},i._sourceBuffer={},i._cleanUpTask={video:[],audio:[],audiovideo:[]},i._mimeCodec={},i._appendEnabled=!0,i}i=e,(t=r).prototype=Object.create(i.prototype),t.prototype.constructor=t,Q(t,i);var o,s,a,f=r.prototype;return f.attach=function(e){var t=this;this.video=e;var i=window.MediaSource||window.WebKitMediaSource;if(i){var r=this._mediaSource=new i;this.video.src=URL.createObjectURL(r),this.video.load(),r.addEventListener("sourceopen",this._onSourceOpen),r.addEventListener("sourceended",this._onSourceEnded),r.addEventListener("sourceclose",this._onSourceClose)}else setTimeout((function(){t.emit(u.default.ERROR,{type:d.ErrorTypes.MSE_ERROR,details:d.ErrorDetails.MEDIASOURCE_ERROR,fatal:!0,info:{reason:"MediaSource is not support"}})}),0)},f.mediaInit=function(e){if((this._hasAudio!==e.hasAudio||this._hasVideo!==e.hasVideo||!!e.audiovideo!=!!this._mimeCodec.audiovideo)&&this.video&&this.hasSourceBuffer()){for(var t in n.Log.i(this.tag,"trackInfo rebuild mse"),this._sourceBuffer)this._sourceBuffer[t]&&this._sbHandler[t]&&(this._sourceBuffer[t].removeEventListener("error",this._sbHandler[t].error),this._sourceBuffer[t].removeEventListener("updateend",this._sbHandler[t].updateend));this._sourceBuffer={},this._mediaSource&&(this._mediaSource.removeEventListener("sourceopen",this._onSourceOpen),this._mediaSource.removeEventListener("sourceended",this._onSourceEnded),this._mediaSource.removeEventListener("sourceclose",this._onSourceClose)),this._mimeCodec={},this.attach(this.video)}e.audiovideo?this._mimeCodec.audiovideo='video/mp4; codecs="'+e.codec+'"':(e.hasAudio&&e.audioCodec&&(this._mimeCodec.audio='audio/mp4; codecs="'+e.audioCodec+'"'),e.hasVideo&&e.videoCodec&&(this._mimeCodec.video='video/mp4; codecs="'+e.videoCodec+'"')),this._hasAudio=this._hasAudio||e.hasAudio,this._hasVideo=this._hasVideo||e.hasVideo,this._checkSourceBuffer()},f.refresh=function(){for(var e in this._sourceBuffer)this._update(e)},f.mediaSegment=function(e){var t=this;e.forEach((function(e){var i,r=e.type;null==(i=t._appendQueue[r])||i.push(e),t._sourceBuffer[r]&&t._update(r)}))},f.bufferedByType=function(e){var t=this._sourceBuffer[e];return t&&t.buffered.length>0?{start:t.buffered.start(0),end:t.buffered.end(t.buffered.length-1)}:{start:0,end:0}},f.bufferedEndByType=function(e){var t=this._sourceBuffer[e];return t&&t.buffered.length>0?t.buffered.end(t.buffered.length-1):0},f.bufferSliceNumByType=function(e){var t=this._sourceBuffer[e];return t?t.buffered.length:0},f.pendingSecByType=function(e){var t=this._appendQueue[e];return t?t.reduce((function(e,t){return e+t.endDTS-t.startDTS}),0):0},f.pendingNum=function(){var e=0;for(var t in this._appendQueue)e+=this._appendQueue[t].length;return e},f.flush=function(e,t,i){var r=0,n=Number.POSITIVE_INFINITY;for(var o in this._endOfData=!1,this._sourceBuffer)if((!i||i===o)&&this._sourceBuffer[o]){if(e){r=Math.max(r,e);for(var s=this._appendQueue[o].length-1;s>=0&&(!this._appendQueue[o][s].startPTS||this._appendQueue[o][s].startPTS>=e);s--)this._appendQueue[o].pop()}else this._appendQueue[o]=[];t&&(n=Math.min(n,t)),this._cleanUpTask[o].push({start:r,end:n}),this._cleanUp(o)}this._appendEnabled=!0},f.setAppendEnabled=function(e){!this._appendEnabled&&e?(this._appendEnabled=e,this.refresh()):this._appendEnabled=e},f.getAppendEnabled=function(){return this._appendEnabled},f.endOfData=function(){this._endOfData=!0,this._hasPendingData()||this._endOfStream()},f.ended=function(){return this._endOfData},f.destroy=function(){if(this._mediaSource){var e=this._mediaSource;if(this._endOfStream(),"closed"!==e.readyState)for(var t in this._sourceBuffer)this._sourceBuffer[t]&&this._sbHandler[t]&&(this._sourceBuffer[t].removeEventListener("error",this._sbHandler[t].error),this._sourceBuffer[t].removeEventListener("updateend",this._sbHandler[t].updateend),e.removeSourceBuffer(this._sourceBuffer[t]));e.removeEventListener("sourceopen",this._onSourceOpen),e.removeEventListener("sourceended",this._onSourceEnded),e.removeEventListener("sourceclose",this._onSourceClose),this._mediaSource=null}this.removeAllListeners(),this._appendQueue={},this._mimeCodec={},this._cleanUpTask={},this._sourceBuffer={},this._sbHandler={}},f.hasCleanUpTask=function(e){var t=0;if(void 0===e)for(var i in this._cleanUpTask)t+=this._cleanUpTask[i].length;else this._cleanUpTask[e]&&(t=this._cleanUpTask[e].length);return t>0},f.hasSourceBuffer=function(){return!!Object.keys(this._sourceBuffer).length},f.getBufferQueueSec=function(e){var t=this;return this._appendQueue?(e?[e]:Object.keys(this._appendQueue)).reduce((function(e,i){return t._appendQueue[i]&&t._appendQueue[i].length>0&&(0===Object.keys(t._sourceBuffer).length||t._sourceBuffer[i])?Math.max(e,t._appendQueue[i].reduce((function(e,t){var i=t.endDTS-t.startDTS;return i?e+i:e}),0)):e}),0):0},f._checkSourceBuffer=function(){var e=(this._hasAudio?1:0)+(this._hasVideo?1:0),t=(this._mimeCodec.audio?1:0)+(this._mimeCodec.video?1:0);if(this._mimeCodec.audiovideo&&(e=1,t=1),n.Log.v(this.tag,"checkSourceBuffer",e,t,this._mimeCodec),this._mediaSource&&"open"===this._mediaSource.readyState&&e>0&&t>=e)for(var i in this._mimeCodec)this._mimeCodec[i]&&this._addSourceBuffer(i)},f._addSourceBuffer=function(e){var t=this;if(!this._sourceBuffer[e]){try{this._mediaSource&&(this._sourceBuffer[e]=this._mediaSource.addSourceBuffer(this._mimeCodec[e]))}catch(e){return n.Log.e(this.tag,e),void this.emit(u.default.ERROR,{type:d.ErrorTypes.MSE_ERROR,details:d.ErrorDetails.ADDSOURCEBUFFER_ERROR,fatal:!0,info:{reason:e.message}})}var i=this._sourceBuffer[e];this._sbHandler[e]={updateend:function(){t._onSourceBufferUpdateEnd(e)},error:function(e){t._onSourceBufferError(e)}},i.addEventListener("error",this._sbHandler[e].error),i.addEventListener("updateend",this._sbHandler[e].updateend),this._duration&&this._mediaSource&&(this._mediaSource.duration=this._duration)}},f._hasPendingData=function(){return!(!this._appendQueue||!(this._appendQueue.video&&this._appendQueue.video.length||this._appendQueue.audio&&this._appendQueue.audio.length))},f._doAppend=function(e){if(this._hasPendingData()){if(!this._appendEnabled)return void(this._getBufferQueueSize()>209715200&&!this._appendBufferError&&(this._appendBufferError=!0,this.emit(u.default.ERROR,{type:d.ErrorTypes.MSE_ERROR,details:d.ErrorDetails.APPENDBUFFER_ERROR,fatal:!0,info:{reason:"bufferfull"}})));if(this._appendQueue[e].length>0&&this._sourceBuffer[e]&&!this._sourceBuffer[e].updating&&!this._appendBufferError){var t=this._appendQueue[e].shift();this._appendBuffer(t)}}},f._calculateRemoveRange=function(e){var t=this.video;if(t&&!t.seeking){var i=t.currentTime;if(this._sourceBuffer[e]){var r=this._cleanUpTask[e],n=this._sourceBuffer[e].buffered;if(n.length>=1&&i-n.start(0)>=10){var o=i-5;if(r.length&&0===r[r.length-1].start&&r[r.length-1].end===o)return;r.push({start:0,end:o})}}}},f._cleanUpRange=function(e,t){var i=this._sourceBuffer[e];if(i){if(i.updating)return!1;try{for(var r=0;r<i.buffered.length;r++){var n=i.buffered.end(r),o=Math.max(0,t.start),s=Math.min(n,t.end);if(s>o&&(i.remove(o,s),this.emit("remove"),r<i.buffered.length-1))return!1}}catch(e){}}return!0},f._appendBuffer=function(e){if(e&&this._sourceBuffer[e.type]&&this.video&&!this.video.error&&this._mediaSource&&"open"===this._mediaSource.readyState)try{this._sourceBuffer[e.type].appendBuffer(e.payload.buffer)}catch(o){if(n.Log.w(this.tag,o.code,this._mediaSource,o),22!==o.code)this._appendError?this._appendError++:this._appendError=1,this._appendError>this._config.appendErrorMaxRetry?(this._appendBufferError=!0,this.emit(u.default.ERROR,{type:d.ErrorTypes.MSE_ERROR,details:d.ErrorDetails.APPENDBUFFER_ERROR,fatal:!0,info:{reason:o.message}})):this._appendQueue[e.type].unshift(e);else{var t=this.video;this._config,this._appendEnabled=!1,this._appendQueue[e.type].unshift(e);var i=t.buffered.end(t.buffered.length-1)-t.currentTime,r=t.currentTime-t.buffered.start(0);i<30?(this._calculateRemoveRange(e.type),this.hasCleanUpTask(e.type)&&this._cleanUp(e.type)):r<10&&this.emit(u.default.ERROR,{type:d.ErrorTypes.MSE_ERROR,details:d.ErrorDetails.APPENDBUFFER_ERROR,fatal:!0,info:{reason:"buffer full, append error"}}),n.Log.i(this.tag,"mse bufferfull"),this.emit("bufferFull")}}},f._endOfStream=function(){var e=this._mediaSource;if(e&&"open"===e.readyState){for(var t in this._sourceBuffer){var i=this._sourceBuffer[t];if(i&&i.updating)return}try{e.endOfStream()}catch(e){n.Log.e(this.tag,e),this.emit(u.default.ERROR,{type:d.ErrorTypes.MSE_ERROR,details:d.ErrorDetails.ENDOFSTREAM_ERROR,fatal:!0,info:{reason:e.message}})}}},f._getBufferQueueSize=function(){var e=0;for(var t in this._appendQueue)e+=this._appendQueue[t].reduce((function(e,t){return t.payload&&t.payload.byteLength?e+t.payload.byteLength:e}),0);return e},f._update=function(e){this.hasCleanUpTask(e)&&this._cleanUp(e),this._doAppend(e)},f._cleanUp=function(e){for(var t=this._cleanUpTask[e];t&&t.length;){var i=t[0];if(!this._cleanUpRange(e,i))return;t.shift()}this.refresh()},o=r,(s=[{key:"readyState",get:function(){return this._mediaSource?this._mediaSource.readyState:"closed"}}])&&G(o.prototype,s),a&&G(o,a),Object.defineProperty(o,"prototype",{writable:!1}),r}(r.EventEmitter),X=window.performance,Z=function(){function e(){this.tag="fps",this._lastDroppedFrames=0,this._lastDecodedFrames=0,this._video=null,this._isVideoPlaybackQualityAvailable=!1,this._lastTime=0,this._decoded=0,this._dropped=0}var t=e.prototype;return t.attachMedia=function(e){var t=this._video=e instanceof window.HTMLVideoElement?e:null;t&&(this._isVideoPlaybackQualityAvailable="function"==typeof t.getVideoPlaybackQuality)},t.destory=function(){},t.reset=function(){this._lastTime=X.now(),this._lastDroppedFrames=this._lastDecodedFrames=this._decoded=this._dropped=0;var e=this._video;if(e)try{if(this._isVideoPlaybackQualityAvailable){var t=e.getVideoPlaybackQuality();this._lastDecodedFrames=t.totalVideoFrames,this._lastDroppedFrames=t.droppedVideoFrames}else this._lastDecodedFrames=e.webkitDecodedFrameCount,this._lastDroppedFrames=e.webkitDroppedFrameCount}catch(e){return}},t.getInfo=function(){var e=this._video,t=X.now(),i=0,r=0;if(e)if(this._isVideoPlaybackQualityAvailable){var n=e.getVideoPlaybackQuality();i=n.totalVideoFrames,r=n.droppedVideoFrames}else i=e.webkitDecodedFrameCount||0,r=e.webkitDroppedFrameCount||0;if(i){i<this._lastDecodedFrames&&(this._lastDecodedFrames=0,this._lastDroppedFrames=0);var o=t-this._lastTime,s=r-this._lastDroppedFrames,a=i-this._lastDecodedFrames,d=0,u=0;return this._lastTime&&(d=parseFloat((1e3*s/o).toFixed(2)),u=parseFloat((1e3*a/o).toFixed(2))),this._decoded=this._decoded+=a,this._dropped=this._dropped+=s,this._lastTime=t,this._lastDroppedFrames=r,this._lastDecodedFrames=i,{decoded:this._decoded,dropped:this._dropped,decodedFPS:u,droppedFPS:d}}this._lastTime=t},e}();function J(){return(J=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(this,arguments)}function Y(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}var $=function(){function e(){this._qos=void 0,this.reset()}var t,i,r,n=e.prototype;return n.reset=function(){this._qos={traffic:0,streams:[],download:[]}},n.onKeyFrame=function(){this._qos.streams[this._qos.streams.length-1].keyFrame++},n.onStreamOpen=function(e,t,i,r){this._qos.streams.length>10&&this._qos.streams.shift(),this._qos.streams.push({index:e,startPos:t,url:i,bitrate:r,traffic:0,loadTimeCost:0,keyFrame:0,videoDataRate:0,audioDataRate:0,segments:{}})},n.onMediaInfo=function(e){var t=this.loadingInfo;t&&(t.mediaInfo=J({},e))},n.onDataReceive=function(e){this._qos.traffic+=e.byteLength;var t=this._qos.download;t.length>200&&t.pop(),t.unshift(e);var i=this._qos.streams[this._qos.streams.length-1];i.traffic+=e.byteLength,i.loadTimeCost+=e.timeCost},n.onMediaSegment=function(e){var t=this._qos,i=t.streams[t.streams.length-1],r=i.segments[e.type]||[];i.segments[e.type]=r,r.push({duration:1e3*(e.endDTS-e.startDTS),dts:1e3*e.startDTS,len:e.payload.byteLength}),r.length>100&&r.shift();for(var n=0,o=0,s=0;s<r.length;s++)o+=r[s].len,n+=r[s].duration;n>0&&("video"===e.type?i.videoDataRate=Math.round(8*o/n):"audio"===e.type&&(i.audioDataRate=Math.round(8*o/n)))},n.getInfoByTime=function(e){for(var t=this._qos.streams.length-1;t>=0;t--)if(this._qos.streams[t].startPos<e)return this._qos.streams[t];return null},n.updateStartPos=function(e){this._qos.streams.length&&(this._qos.streams[this._qos.streams.length-1].startPos=e)},t=e,(i=[{key:"loadingInfo",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1]:null}},{key:"downloadSpeed",get:function(){for(var e=this._qos,t=performance.now(),i=0,r=0,n=0;n<e.download.length&&e.download[n].ts>t-1e3;n++)i+=e.download[n].byteLength,r+=e.download[n].timeCost;return Math.round(i/r*1e3)||0}},{key:"mediaInfo",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].mediaInfo:null}},{key:"videoDataRate",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].videoDataRate:0}},{key:"audioDataRate",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].audioDataRate:0}},{key:"bitrate",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].bitrate:0}},{key:"traffic",get:function(){return this._qos.traffic}},{key:"data",get:function(){return this._qos}}])&&Y(t.prototype,i),r&&Y(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function ee(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}function te(e,t){return(te=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var ie,re=function(e){var t,i;function r(t){var i;return(i=e.call(this)||this)._media=void 0,i._playbackQuality=void 0,i._data=void 0,i._playing=!1,i._sm=void 0,i._hbTimer=void 0,i._heartbeat=function(){i._refresh();var e=i._data,t=i._sm,r={totalReceive:t.traffic,speed:t.downloadSpeed,videoDataRate:t.videoDataRate,audioDataRate:t.audioDataRate,decodedFPS:e.decodedFPS,droppedFPS:e.droppedFPS,decodedFrames:e.decodedFrames,droppedFrames:e.droppedFrames};i.emit(u.default.HEARTBEAT,r)},i._sm=new $,i._media=t,i.reset(),i}i=e,(t=r).prototype=Object.create(i.prototype),t.prototype.constructor=t,te(t,i);var n,o,s,a=r.prototype;return a.reset=function(){this._data={decodedFPS:0,droppedFPS:0,decodedFrames:0,droppedFrames:0,loadStartTime:0,firstFrameTime:0,blockDuration:0,blockCount:0,downloadedBytes:0},this._sm.reset(),this._playbackQuality&&this._playbackQuality.reset(),this._refresh()},a.onReport=function(e){e.ts=e.ts||performance.now();var t=this._data;switch(e.type){case B:t.downloadedBytes+=e.byteLength,this._sm.onDataReceive(e);break;case F:this._sm.onStreamOpen(e.index||0,e.sync,e.url,e.bitrate);break;case N:this._sm.onKeyFrame()}},a.destroy=function(){this._playbackQuality&&(this._playbackQuality.destory(),this._playbackQuality=void 0),this._stopHeartbeat()},a.onLoad=function(){this._startHeartbeat(),this._media.video&&(this._playbackQuality=new Z,this._playbackQuality.attachMedia(this._media.video))},a.onSegmentInit=function(e){this._sm.onMediaInfo(e)},a.onLoadeddata=function(){this._onFirstFrame(),this._waitingEnd()},a.onCanplay=function(){this._onFirstFrame(),this._waitingEnd()},a.onPlaying=function(){this._playing=!0,this._waitingEnd()},a.onEnd=function(){this._waitingEnd()},a.onWaiting=function(e){this._playing&&this._data.firstFrameTime&&e&&this._waitingStart()},a.onStopLoad=function(){this._stopHeartbeat()},a.onSegment=function(e){var t=this;e.segments.forEach((function(e){t._sm.onMediaSegment(e)}))},a._refresh=function(){var e;this._playbackQuality&&(e=this._playbackQuality.getInfo());var t=this._data;e?(t.decodedFPS=e.decodedFPS,t.droppedFPS=e.droppedFPS,t.droppedFrames=e.dropped,t.decodedFrames=e.decoded):t.decodedFPS=t.droppedFPS=t.droppedFrames=t.decodedFrames=0},a._onFirstFrame=function(){this._data.firstFrameTime||(this._data.firstFrameTime=performance.now())},a._waitingStart=function(){this._data.bufferingStartMS||(this._data.blockCount++,this._data.bufferingStartMS=this._data.bufferingStartMS||performance.now())},a._waitingEnd=function(){this._data.bufferingStartMS&&(this._data.blockDuration+=performance.now()-this._data.bufferingStartMS),this._data.bufferingStartMS=null},a._startHeartbeat=function(){this._hbTimer||(this._hbTimer=setInterval(this._heartbeat,1e3))},a._stopHeartbeat=function(){this._hbTimer&&(clearInterval(this._hbTimer),this._hbTimer=void 0)},n=r,(o=[{key:"data",get:function(){return this._data}}])&&ee(n.prototype,o),s&&ee(n,s),Object.defineProperty(n,"prototype",{writable:!1}),r}(r.EventEmitter),ne=i("./src/utils/browser-helper.ts"),oe=function(){function e(e,t){this.tag="PlaybackRateManager",this._media=void 0,this._config=void 0,this._interval=0,this._timer=void 0,this._media=e,this._config=t}var t=e.prototype;return t.start=function(){this._interval=this._interval||this._config.startDelay||this._config.interval||5,this._tick(),this._interval=this._config.interval||1},t.stop=function(){this._timer&&(clearTimeout(this._timer),this._timer=0)},t.destroy=function(){this._timer&&(clearTimeout(this._timer),this._timer=0)},t._tick=function(){var e=this;this._timer||(this._timer=setTimeout((function(){e._media.video&&e._nextPlayBackRate(e._media.bufferedSec(),e._media.video),e._timer=0,e._tick()}),1e3*this._interval))},t._nextPlayBackRate=function(e,t){var i=1,r=this._config.rule,o=0;for(o=0;o<r.length&&!(t.playbackRate>=r[o].rate);o++);var s=o<r.length-1?r[o+1]:null,a=o>0?r[o-1]:null;i=r[o].rate,a&&e>a.lower&&(i=a.rate),s&&e<s.upper&&(i=s.rate),t.playbackRate!==i&&(n.Log.i(this.tag,"auto change playback rate from "+t.playbackRate+" to "+i),t.playbackRate=i)},e}();function se(){return(se=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(this,arguments)}function ae(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(n=r.key,o=void 0,"symbol"==typeof(o=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"))?o:String(o)),r)}var n,o}function de(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ue(e,t){return(ue=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}!function(e){e[e.NONE=0]="NONE",e[e.WAITING=1]="WAITING",e[e.SEEK=2]="SEEK",e[e.SELECT_BITRATE=3]="SELECT_BITRATE",e[e.INIT=4]="INIT"}(ie||(ie={}));var fe=function(e){var t,i;function r(t){var i;return(i=e.call(this)||this).tag="las",i._config=void 0,i._src=void 0,i._video=void 0,i._mse=void 0,i._lasMain=void 0,i._stat=ie.INIT,i._audioCodecSwap=!1,i._error=void 0,i._audioCodec="",i._recoverMediaErrorTime=0,i._mainTimer=void 0,i._media=void 0,i._nextLevel=[],i._mediaInfo=void 0,i._loadStopped=!1,i._seekOnUpdateEnd=!1,i._playingLevel=void 0,i._startLevel=void 0,i._monitor=void 0,i._playbackRateManager=void 0,i._onVideoLoadeddata=function(){n.Log.i(i.tag,"loadeddata"),i._monitor.onLoadeddata()},i._onVideoCanplay=function(){n.Log.v(i.tag,"canplay "+!!i._stat),i._monitor.onCanplay(),i._video&&i._stat!==ie.NONE&&(i._stat=ie.NONE,i._checkLevelChange(),i._video.paused||i._onVideoPlaying())},i._onVideoWaiting=function(){if(i._video){i._stat=i._stat||ie.WAITING;var e=!i._video.seeking&&i._stat===ie.WAITING;e&&n.Log.i(i.tag,"waiting currentTime:",i._video.currentTime),i._monitor.onWaiting(e)}},i._onVideoPlaying=function(){n.Log.i(i.tag,"playing"),i._error||(i._stat=ie.NONE,i._monitor.onPlaying())},i._onVideoEnded=function(){i._monitor.onEnd(),i._mse&&i._mse.flush()},i._onVideoError=function(e){if(n.Log.e(i.tag,"video error",e),!i._error){if(i._config.autoRecoverMedia){var t=performance.now();if((!i._recoverMediaErrorTime||t-i._recoverMediaErrorTime>3e3)&&i._recoverSwapRemuxType())return void(i._recoverMediaErrorTime=t);if(i._recoverSwapAudioCodec())return}var r="video error";i._video&&i._video.error&&(r+=" code:"+i._video.error.code+" message:"+i._video.error.message),i._onError({type:d.ErrorTypes.MEDIA_ERROR,details:d.ErrorDetails.VIDEO_ERROR,fatal:!0,info:{reason:r}})}},i._resetMSE=function(){i._seekOnUpdateEnd=!1,i._video&&(n.Log.i(i.tag,"rebuild mse"),URL.revokeObjectURL(i._video.src),i._video.src="",i._video.removeAttribute("src"),i._destroyMSE(),i._initMSE())},i._mainLoop=function(){var e=i._video;if(e&&(i._stat===ie.WAITING&&!e.seeking||i._stat===ie.INIT||i._stat===ie.SEEK||i._stat===ie.SELECT_BITRATE)&&i._mse&&!i._mse.hasCleanUpTask()&&!e.ended){var t=e.currentTime,r=i._media.currentBuffer(t),o=void 0;if(!r||r.end-t<1){var s=i._media.nextBuffer(t);s&&(n.Log.i(i.tag,"try fix block-A"),o=s.start)}else e.buffered.length>1&&r.end-t>1&&(n.Log.i(i.tag,"try fix block-B"),o=r.start);o&&(o+=ne.default.isSafari?.3:.001,i._internalSeek(o),n.Log.i(i.tag,"jump to "+o))}i._nextLevel.length&&i._checkLevelChange()},i.off||(i.off=i.removeListener),i._config=a.processConfig(t),i._media=new q,i._config?r.isSupported()?(i._mainTimer=null,i._stat=ie.INIT,i._startMainTimer(),i._initMonitor(),i._config.autoPlaybackRateConf&&(i._playbackRateManager=new oe(i._media,i._config.autoPlaybackRateConf)),n.Log.i(i.tag,r.version,i._config),i):(setTimeout((function(){i._onError({type:d.ErrorTypes.OTHER_ERROR,details:d.ErrorDetails.UNSUPPORTED,fatal:!0,info:{reason:"unsupported"}})}),0),de(i)):(setTimeout((function(){i._onError({type:d.ErrorTypes.OTHER_ERROR,details:d.ErrorDetails.CONFIG_ERROR,fatal:!0,info:{reason:"config data error"}})}),0),de(i))}i=e,(t=r).prototype=Object.create(i.prototype),t.prototype.constructor=t,ue(t,i),r.isSupported=function(){return e=window.MediaSource||window.WebKitMediaSource,t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove,n=m.isSupported()||y.isSupportedChunk()===p.MOZ_CHUNK,i&&r&&n;var e,t,i,r,n};var o,s,f,h=r.prototype;return h.attachMedia=function(e){this._video=e,this._media.attachVideo(this._video),this._initMSE(),this._bindVideoEvents()},h.load=function(e){void 0===e&&(e=void 0),this._video||this._onError({type:d.ErrorTypes.OTHER_ERROR,details:d.ErrorDetails.NO_VIDEO,fatal:!0,info:{reason:"no video attached"}}),this._playingLevel=void 0,this._monitor.reset(),e&&(this._src=e),this._load()},h.resume=function(){n.Log.i(this.tag,"call resume"),this._loadStopped&&(this._loadStopped=!1,this._load()),this._video&&this._video.paused&&this._video.play()},h.destroy=function(){this._playbackRateManager&&this._playbackRateManager.destroy(),this._stopMonitor(),this._stopMainTimer(),this._unbindVideoEvents(),this._stopVideo(),this.removeAllListeners()},h.refresh=function(e){void 0===e&&(e=!1),n.Log.i(this.tag,"call refresh"),(this._config.autoRecoverMedia||this._error!==d.ErrorDetails.VIDEO_ERROR||!this._recoverSwapRemuxType()&&!this._recoverSwapAudioCodec())&&this._reload(e),this._error=void 0},h.stopLoad=function(){n.Log.i(this.tag,"call stopLoad"),this._lasMain&&(this._destroyLasMain(),this._mse.endOfData(),this._loadStopped=!0,this._monitor.onStopLoad()),this._playbackRateManager&&this._playbackRateManager.stop()},h.getMediaInfo=function(){return se({},this._mediaInfo)},h._reload=function(e){void 0===e&&(e=!1),this._lasMain&&this._mse||this._error?(this._lasMain&&(this._startLevel=this._lasMain.currentLevel),this._nextLevel=[],e&&this._mse?(this._mse.flush(),this._internalSeek(0),this._seekOnUpdateEnd=!0):(this._stopVideo(),this._initMSE()),this._destroyLasMain(),this._initLasMain(),this._lasMain&&this._lasMain.load()):n.Log.v(this.tag,"transmuxer & mediaSource not ready")},h._bindVideoEvents=function(){this._video&&(this._video.addEventListener("loadeddata",this._onVideoLoadeddata),this._video.addEventListener("canplay",this._onVideoCanplay),this._video.addEventListener("waiting",this._onVideoWaiting),this._video.addEventListener("playing",this._onVideoPlaying),this._video.addEventListener("ended",this._onVideoEnded),this._video.addEventListener("error",this._onVideoError))},h._unbindVideoEvents=function(){this._video&&(this._video.removeEventListener("loadeddata",this._onVideoLoadeddata),this._video.removeEventListener("canplay",this._onVideoCanplay),this._video.removeEventListener("waiting",this._onVideoWaiting),this._video.removeEventListener("playing",this._onVideoPlaying),this._video.removeEventListener("ended",this._onVideoEnded),this._video.removeEventListener("error",this._onVideoError))},h._initMSE=function(){var e=this;if(this._video){var t=this._video;this._mse=new K(this._config),this._mse.attach(t),this._media.attachMSE(this._mse),this._mse.on(u.default.ERROR,(function(t){e._onError(t)})),this._mse.on("updateend",(function(){e._seekOnUpdateEnd&&t.buffered.length&&(n.Log.i(e.tag,"seek on updateend"),e._internalSeek(t.buffered.start(0)),e._seekOnUpdateEnd=!1)})),this._mse.on("resetDone",(function(){e._seekOnUpdateEnd=!0}))}},h._destroyMSE=function(){this._mse&&(this._mse.removeAllListeners(),this._mse.destroy())},h._load=function(){this._loadStopped=!1,this._error=void 0,this._stat=ie.INIT,this._nextLevel=[],this._media.reset(),this._monitor.onLoad(),this._lasMain&&this._destroyLasMain(),(this._mse.hasSourceBuffer()||this._video&&this._video.error)&&this._resetMSE(),this._initLasMain(),this._lasMain&&this._lasMain.load(),this._config.autoPlaybackRate&&this._playbackRateManager&&this._playbackRateManager.start()},h._verifyLevel=function(e){return!(!(this._lasMain&&this._lasMain.levels.length>0&&e<this._lasMain.levels.length&&e>=-1&&this._video)||this._video.ended)},h._initLasMain=function(){this._lasMain=new z(this._config,this._media),this._bindLasMainEvent(this._lasMain),this._lasMain.init(this._src,this._audioCodec)},h._destroyLasMain=function(){this._lasMain&&(this._lasMain.removeAllListeners(),this._lasMain.destroy(),this._lasMain=void 0)},h._bindLasMainEvent=function(e){var t=this,i=this._mse;e.on(u.default.MP4_SEGMENT,(function(e){i&&i.mediaSegment(e.segments),t._monitor&&t._monitor.onSegment(e)})),e.on(u.default.MEDIA_INFO,(function(e){var r=se({},e);t._monitor.onSegmentInit(r),t.emit(u.default.MEDIA_INFO,r),t._mediaInfo=r,t._audioCodec=e.defaultAudioCodec||e.audioCodec,i&&i.mediaInit(r)})),e.on(u.default.ERROR,(function(e){t._onError(e)})),e.on(u.default.LOAD_END,(function(){i&&i.endOfData(),t.emit(u.default.LOAD_END)})),e.on(u.default.LEVEL_SWITCH_FAILED,(function(e){t.emit(u.default.LEVEL_SWITCH_FAILED,e)})),e.on(u.default.LEVEL_SWITCHING,(function(e){!e.smooth&&t._mse&&t._mse.flush(),t.emit(u.default.LEVEL_SWITCHING,{level:e.level}),t._nextLevel=t._nextLevel.sort((function(e,t){return e.startSec-t.startSec})).filter((function(t){return t.startSec<e.startSec})),t._nextLevel.push(e)})),e.on(u.default.SCRIPT_PARSED,(function(e){t.emit(u.default.SCRIPT_PARSED,e)})),e.on(u.default.MANIFEST_PARSED,(function(i){"number"!=typeof t._playingLevel?("number"==typeof t._startLevel&&(e.currentLevel=t._startLevel),i=se({levels:t.levels.slice(0),currentLevel:t.currentLevel},i),t._playingLevel=e.currentLevel,n.Log.i(t.tag,u.default.MANIFEST_PARSED,i),t.emit(u.default.MANIFEST_PARSED,i)):e.currentLevel=t._playingLevel})),e.on(u.default.REPORT,(function(e){t._monitor&&t._monitor.onReport(e)}))},h._internalSeek=function(e){this._video&&(this._video.currentTime=e)},h._onError=function(e){n.Log.i(this.tag,"on error "+JSON.stringify(e)),!e.info.url&&this.levels&&this.levels[this.currentLevel]&&(e.info.url=this.levels[this.currentLevel].url),e.fatal&&(this.stopLoad(),this._stopMainTimer(),(e.details===d.ErrorDetails.VIDEO_ERROR||this._video&&this._video.error)&&this._destroyMSE(),this._error||(this._error=e.details,this.emit(u.default.ERROR,e)))},h._startMainTimer=function(){null===this._mainTimer&&(this._mainTimer=setInterval(this._mainLoop,200))},h._stopMainTimer=function(){this._mainTimer&&(clearInterval(this._mainTimer),this._mainTimer=null)},h._checkLevelChange=function(){var e=this._nextLevel[0];this._video&&e&&this._video.currentTime>=e.startSec&&this._media.isTimeinBuffered(this._video.currentTime)&&(this.emit(u.default.LEVEL_SWITCHED,{level:e.level}),this._playingLevel=e.level,this._nextLevel.shift())},h._stopVideo=function(){this._video&&(URL.revokeObjectURL(this._video.src),this._video.src="",this._video.removeAttribute("src"),this._destroyLasMain(),this._destroyMSE())},h._initMonitor=function(){var e=this;this._monitor||(this._monitor=new re(this._media),this._monitor.on(u.default.HEARTBEAT,(function(t){e.emit(u.default.HEARTBEAT,t)})))},h._stopMonitor=function(){this._monitor&&(this._monitor.destroy(),this._monitor.removeAllListeners())},h._recoverSwapRemuxType=function(){var e=this._config.gopRemux;return this._config.gopRemux=!0,e!==this._config.gopRemux&&(n.Log.i(this.tag,"recover swap remux type"),this._reload(),!0)},h._recoverSwapAudioCodec=function(){return!(this._audioCodecSwap||!this._audioCodec||(-1!==this._audioCodec.indexOf("mp4a.40.5")?this._audioCodec="mp4a.40.2":this._audioCodec="mp4a.40.5",this._audioCodecSwap=!0,n.Log.i(this.tag,"recover swap audio codec"),this._reload(),0))},o=r,f=[{key:"version",get:function(){return"1.0.6"}},{key:"Events",get:function(){return u.default}},{key:"ErrorTypes",get:function(){return d.ErrorTypes}},{key:"ErrorDetails",get:function(){return d.ErrorDetails}}],(s=[{key:"autoLevelEnabled",get:function(){return!!this._lasMain&&this._lasMain.autoLevelEnabled}},{key:"levels",get:function(){return this._lasMain&&this._lasMain.levels.slice(0),[]}},{key:"nextLevel",get:function(){return this._lasMain?this._lasMain.nextLevel:0},set:function(e){this._verifyLevel(e)&&this._lasMain?this._lasMain.nextLevel=e:this.emit(u.default.LEVEL_SWITCH_FAILED,{level:e})}},{key:"currentLevel",get:function(){return this._lasMain?this._lasMain.currentLevel:0},set:function(e){this._verifyLevel(e)&&this._lasMain?-1===e?this._lasMain.nextLevel=e:(this._stat=ie.SELECT_BITRATE,this._seekOnUpdateEnd=!0,this._mse&&this._mse.flush(),this._lasMain.currentLevel=e):this.emit(u.default.LEVEL_SWITCH_FAILED,{level:e})}},{key:"startLevel",get:function(){return void 0===this._startLevel?-1:this._startLevel},set:function(e){this._startLevel=e}},{key:"monitorData",get:function(){if(this._monitor)return this._monitor.data}}])&&ae(o.prototype,s),f&&ae(o,f),Object.defineProperty(o,"prototype",{writable:!1}),r}(r.EventEmitter)},"./src/types/flv-object.ts":function(e,t,i){"use strict";var r;i.r(t),i.d(t,"FlvTagType",(function(){return r})),i.d(t,"FlvSize",(function(){return n})),i.d(t,"FlvTag",(function(){return o})),function(e){e[e.AUDIO=8]="AUDIO",e[e.VIDEO=9]="VIDEO",e[e.SCRIPT=18]="SCRIPT"}(r||(r={}));var n={FLV_HEAD_LEN:13,FLV_TAG_HEAD_LEN:11,FLV_TAG_SIZE_LEN:4,AVC_KEY_FRAME_CHECK_LEN:2},o=function(){this.tagType=r.VIDEO,this.dataSize=0,this.timestamp=0,this.size=0,this.cts=0,this.frameType=0,this.codecId=0,this.body=null}},"./src/utils/browser-helper.ts":function(e,t,i){"use strict";i.r(t);var r,n,o=(r=navigator.vendor,n=navigator.userAgent,{isSafari:!(!(r&&r.indexOf("Apple")>-1&&n)||n.match("CriOS")),isFirefox:/firefox/i.test(n),isAndroid:/android/i.test(n)});t.default=o},"./src/utils/log.ts":function(e,t,i){"use strict";var r;function n(e,t){return t&&0!==t.length||(t=[e],e=""),e="las.js-"+(e?"::"+e:""),t.unshift("["+e+"] > "),t}i.r(t),i.d(t,"Log",(function(){return o})),i.d(t,"LOG_LEVEL",(function(){return r})),function(e){e.LEVEL_SILENT="s",e.LEVEL_ERROR="e",e.LEVEL_WARN="w",e.LEVEL_INFO="i",e.LEVEL_DEBUG="d",e.LEVEL_VERBOSE="v"}(r||(r={}));var o=function(){function e(){}return e.level=function(t){switch(e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=e.ENABLE_DEBUG=e.ENABLE_VERBOSE=!1,t){case r.LEVEL_WARN:e.ENABLE_ERROR=e.ENABLE_WARN=!0;break;case r.LEVEL_INFO:e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=!0;break;case r.LEVEL_DEBUG:e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=e.ENABLE_DEBUG=!0;break;case r.LEVEL_VERBOSE:e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=e.ENABLE_DEBUG=e.ENABLE_VERBOSE=!0;break;case r.LEVEL_SILENT:break;default:e.ENABLE_ERROR=!0}},e.e=function(t){if(e.ENABLE_ERROR){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];var s=n(t,r);(console.error||console.warn||console.log).apply(console,s)}},e.w=function(t){if(e.ENABLE_WARN){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];var s=n(t,r);(console.warn||console.log).apply(console,s)}},e.i=function(t){if(e.ENABLE_INFO){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];var s=n(t,r);(console.info||console.log).apply(console,s)}},e.d=function(t){if(e.ENABLE_DEBUG){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];var s=n(t,r);(console.debug||console.log).apply(console,s)}},e.v=function(t){if(e.ENABLE_VERBOSE){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];var s=n(t,r);console.log.apply(console,s)}},e}();o.ENABLE_ERROR=!1,o.ENABLE_WARN=!1,o.ENABLE_INFO=!1,o.ENABLE_DEBUG=!1,o.ENABLE_VERBOSE=!1}}).default},e.exports=r())},349:function(e,t,i){"use strict";i.r(t);var r,n=i(189),o=i(231),s=i.n(o),a=i(22),d=i(2),u=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),f=d.a.log.bind(null,"[@LASDemux]"),h=d.a.warn.bind(null,"[@LASDemux]"),l=function(e){function t(t){var i=e.call(this,t)||this;if("string"==typeof t.urls)throw new Error("urls must be array");return i._level=Math.min(t.urls.length-1,t.startLevel),i._manifest={version:"1.0.0",adaptationSet:[{duration:1e3,id:1,representation:t.urls.map((function(e,t){return{id:t,url:e,disabledFromAdaptive:!0,defaultSelected:t===i._level}}))}]},i._levels=t.urls.map((function(e,t){return{id:t,bitrate:e}})),i}return u(t,e),t.prototype.destry=function(e){void 0===e&&(e=!0),this._demux&&(this._demux.removeAllListeners(),this._demux.stopLoad(),this._demux.destroy(),e&&this.emit(a.b.DESTROYED))},t.prototype.startLoad=function(e){this._demux=new s.a({credentials:!1,webWorker:!0,autoRecoverMedia:!1,defaultLiveDelay:void 0,debug:"v"}),this.attachMedia(),this.addListeners(),this._demux.load(JSON.stringify(this._manifest)),this.initBitrate()},Object.defineProperty(t.prototype,"level",{set:function(e){var t=this._level=this._levels.findIndex((function(t){return t.id===e}));this._demux.currentLevel=this._demux.nextLevel=this._level=t},enumerable:!1,configurable:!0}),t.prototype.attachMedia=function(){f("\u7ed1\u5b9aLas\u89e3\u7801\u5668",this._media,s.a.version),this._demux.attachMedia(this._media)},t.prototype.addListeners=function(){var e=this;this._demux.once(s.a.Events.MANIFEST_PARSED,(function(){e._demux.startLevel=e._demux.currentLevel=e._demux.nextLevel=e._level})),this._demux.on(s.a.Events.LEVEL_SWITCHED,(function(){e.onSwitched()})),this._demux.on(s.a.Events.LEVEL_SWITCHING,(function(){e.onSwitching()})),this._demux.on(s.a.Events.ERROR,(function(t){t.type===s.a.ErrorTypes.MSE_ERROR&&t.details===s.a.ErrorDetails.APPENDBUFFER_ERROR?(h("appBuffer error restart las",e._level),e._demux.startLevel=e._level,e._demux.refresh()):h(t.details,t.type,JSON.stringify(t.info))})),this._demux.on(s.a.Events.MEDIA_INFO,(function(t){e._codecs=e._codecs="".concat(t.videoCodec,",").concat(t.audioCodec),e.emit(a.b.METADATA,t)})),this._demux.on("heartbeat",(function(t){e.appendBandwidth(t.speed/1024)}))},t}(n.a);t.default=l}}]);